import datetime
from math import floor, ceil
from typing import Dict, List
import numpy as np
import google.generativeai as genai
import json
import re

# ğŸš¨ 1. [í•„ìˆ˜] TIME_ZONE ìƒìˆ˜ ì •ì˜ ì¶”ê°€ (SajuEngine ë°–ì—ì„œ ì‚¬ìš©ë¨)
TIME_ZONE = datetime.timezone(datetime.timedelta(hours=9)) 

# --- [1. ì‚¬ì£¼ ë°ì´í„° ìƒìˆ˜ ì„í¬íŠ¸ (saju_data.py íŒŒì¼ í•„ìˆ˜)] ---
try:
    from saju_data import (
        CHEONGAN, JIJI, GANJI_60, 
        DAY_STEM_TO_TIME_STEM_START_INDEX, 
        YEAR_STEM_TO_MONTH_STEM_INDEX,
        O_HAENG_MAP,
        TEN_GAN_PERSONA
    )
    # ğŸ”§ saju_data_updated.pyì—ì„œ ì ìˆ˜ ê³„ì‚° í•¨ìˆ˜ ì„í¬íŠ¸
    from saju_data_updated import (
        calculate_total_luck_score,
        JOHU_SCORES_LOOKUP,
        JIJI_SCORES_LOOKUP,
        SINJEONG_JOHU_SCORES_LOOKUP
    )
except ImportError as e:
    print(f"ğŸš¨ ì˜¤ë¥˜: saju_data.py ë˜ëŠ” saju_data_updated.py íŒŒì¼ì´ ì—†ê±°ë‚˜ ìƒìˆ˜ê°€ ëˆ„ë½ë˜ì—ˆìŠµë‹ˆë‹¤: {e}")
    raise

# --------------------------------------------------------------------------
# 2. ì„ìƒ ë°ì´í„° ë¡œë“œ í•¨ìˆ˜
# --------------------------------------------------------------------------
def load_clinical_data(file_path: str = "saju-study-data-all.txt") -> str:
    """
    saju-study-data-all.txt íŒŒì¼ì„ ì½ì–´ì™€ AI í”„ë¡¬í”„íŠ¸ì— ì‚½ì…í•  ìˆ˜ ìˆëŠ” ë¬¸ìì—´ë¡œ ë°˜í™˜í•©ë‹ˆë‹¤.
    """
    try:
        with open(file_path, 'r', encoding='utf-8') as f:
            data_content = f.read().strip()
            return data_content
            
    except FileNotFoundError:
        return "ğŸš¨ ì„ìƒ ë°ì´í„° íŒŒì¼ (saju-study-data-all.txt)ì„ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤. ë¶„ì„ì˜ ê¹Šì´ê°€ ì œí•œë©ë‹ˆë‹¤."
    except Exception as e:
        return f"ğŸš¨ ì„ìƒ ë°ì´í„° ë¡œë“œ ì¤‘ ì˜¤ë¥˜ ë°œìƒ: {e}"


# --------------------------------------------------------------------------
# 2-0. ì›”ë³„ ìš´ì„¸ ì ìˆ˜ ê³„ì‚° í•¨ìˆ˜ (í…Œì´ë¸” ê¸°ë°˜ - NEW)
# --------------------------------------------------------------------------
# 2026ë…„ ì›”ë³„ ê°„ì§€ (ë³‘ì˜¤ë…„ ê¸°ì¤€)
MONTHLY_GANJI_2026 = {
    1: ('åºš', 'å¯…'),   # ê²½ì¸ì›”
    2: ('è¾›', 'å¯'),   # ì‹ ë¬˜ì›”
    3: ('å£¬', 'è¾°'),   # ì„ì§„ì›”
    4: ('ç™¸', 'å·³'),   # ê³„ì‚¬ì›”
    5: ('ç”²', 'åˆ'),   # ê°‘ì˜¤ì›”
    6: ('ä¹™', 'æœª'),   # ì„ë¯¸ì›”
    7: ('ä¸™', 'ç”³'),   # ë³‘ì‹ ì›”
    8: ('ä¸', 'é…‰'),   # ì •ìœ ì›”
    9: ('æˆŠ', 'æˆŒ'),   # ë¬´ìˆ ì›”
    10: ('å·±', 'äº¥'),  # ê¸°í•´ì›”
    11: ('åºš', 'å­'),  # ê²½ìì›”
    12: ('è¾›', 'ä¸‘'),  # ì‹ ì¶•ì›”
}

def calculate_monthly_flow_scores(manse_info: Dict) -> List[int]:
    """
    ì‚¬ì£¼ ë°ì´í„°ì™€ saju_data_updated.pyì˜ í…Œì´ë¸”ì„ ì‚¬ìš©í•˜ì—¬ 
    2026ë…„ ì›”ë³„ ìš´ì„¸ ì ìˆ˜ë¥¼ ê³„ì‚°í•©ë‹ˆë‹¤.
    
    ë™ì¼í•œ ì‚¬ì£¼ì— ëŒ€í•´ í•­ìƒ ë™ì¼í•œ ì ìˆ˜ë¥¼ ë°˜í™˜í•©ë‹ˆë‹¤.
    
    Parameters:
        manse_info: ì‚¬ì£¼ ëª…ì‹ ì •ë³´ (ì¼ê°„, ì›”ì§€, ì¼ì§€ í¬í•¨)
    
    Returns:
        List[int]: 1ì›”~12ì›” ì ìˆ˜ (ê° 0~100 ë²”ìœ„)
    """
    ilgan = manse_info.get('ì¼ì£¼', ['', ''])[0]  # ì¼ê°„ (ì²œê°„)
    wolji = manse_info.get('ì›”ì£¼', ['', ''])[1]  # ì›”ì§€ (ì§€ì§€)
    ilji = manse_info.get('ì¼ì£¼', ['', ''])[1]   # ì¼ì§€ (ì§€ì§€)
    
    if not ilgan or not wolji or not ilji:
        # ë°ì´í„° ì—†ìœ¼ë©´ ê¸°ë³¸ê°’ ë°˜í™˜
        return [65, 70, 75, 60, 80, 55, 65, 70, 85, 75, 70, 65]
    
    scores = []
    is_sin_or_jeong = ilgan in ['è¾›', 'ä¸']
    
    for month in range(1, 13):
        month_cheongan, month_jiji = MONTHLY_GANJI_2026[month]
        
        # saju_data_updated.pyì˜ calculate_total_luck_score ì‚¬ìš©
        sa_ju_data = {
            'ì¼ê°„': ilgan,
            'ì›”ì§€': wolji,
            'ì¼ì§€': ilji
        }
        luck_data = {
            'ì²œê°„': month_cheongan,
            'ì§€ì§€': month_jiji,
            'ìš´ì˜ì¢…ë¥˜': 'ì›”ìš´'
        }
        
        result = calculate_total_luck_score(sa_ju_data, luck_data)
        total_score = result.get('total', 60)
        
        # ì ìˆ˜ë¥¼ ì •ìˆ˜ë¡œ ë³€í™˜ (35~95 ë²”ìœ„ë¡œ ì¡°ì •)
        adjusted_score = int(min(95, max(35, total_score)))
        scores.append(adjusted_score)
    
    return scores


def _format_monthly_scores_for_prompt(monthly_scores: List[int]) -> str:
    """
    ì›”ë³„ ì ìˆ˜ë¥¼ AI í”„ë¡¬í”„íŠ¸ìš© ë¬¸ìì—´ë¡œ í¬ë§·íŒ…í•©ë‹ˆë‹¤.
    """
    if not monthly_scores or len(monthly_scores) != 12:
        return "[ì›”ë³„ ì ìˆ˜ ë°ì´í„° ì—†ìŒ]"
    
    def get_grade(score: int) -> str:
        if score >= 80:
            return "â˜…â˜…â˜… ë§¤ìš°ì¢‹ìŒ"
        elif score >= 70:
            return "â˜…â˜…â˜† ì¢‹ìŒ"
        elif score >= 55:
            return "â˜…â˜†â˜† ë³´í†µ"
        elif score >= 45:
            return "â˜†â˜†â˜† ì£¼ì˜"
        else:
            return "âš ï¸ ì‹ ì¤‘"
    
    lines = []
    for i, score in enumerate(monthly_scores):
        month = i + 1
        grade = get_grade(score)
        lines.append(f"  {month}ì›”: {score}ì  ({grade})")
    
    return "\n".join(lines)


# --------------------------------------------------------------------------
# 2-1. ëª…ë¦¬í•™ íŒ¨í„´ JSON ë¡œë“œ í•¨ìˆ˜ (NEW)
# --------------------------------------------------------------------------
def load_special_patterns(file_path: str = "knowledge/special_patterns.json") -> Dict:
    """
    knowledge/special_patterns.json íŒŒì¼ì„ ë¡œë“œí•˜ì—¬ ëª…ë¦¬í•™ íŒ¨í„´ ë°ì´í„°ë¥¼ ë°˜í™˜í•©ë‹ˆë‹¤.
    
    Returns:
        Dict: íŒ¨í„´ ë°ì´í„° (meta, patterns í¬í•¨)
    """
    try:
        with open(file_path, 'r', encoding='utf-8') as f:
            data = json.load(f)
            return data
    except FileNotFoundError:
        print(f"ğŸš¨ íŒ¨í„´ íŒŒì¼ì„ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤: {file_path}")
        return {"meta": {}, "patterns": []}
    except json.JSONDecodeError as e:
        print(f"ğŸš¨ íŒ¨í„´ JSON íŒŒì‹± ì˜¤ë¥˜: {e}")
        return {"meta": {}, "patterns": []}
    except Exception as e:
        print(f"ğŸš¨ íŒ¨í„´ ë¡œë“œ ì¤‘ ì˜ˆìƒì¹˜ ëª»í•œ ì˜¤ë¥˜: {e}")
        return {"meta": {}, "patterns": []}


def find_patterns_in_chart(saju_data: Dict, patterns_db: Dict = None) -> List[Dict]:
    """
    ì‚¬ì£¼ ëª…ì‹ ë°ì´í„°ì—ì„œ ë°œë™ë˜ëŠ” íŠ¹ìˆ˜ íŒ¨í„´(ìí˜•, ì¶©, í˜•, íŠ¹ìˆ˜ ì‹ ì‚´)ì„ ê²€ìƒ‰í•©ë‹ˆë‹¤.
    
    Args:
        saju_data: ì‚¬ì£¼ ëª…ì‹ ë°ì´í„° (ë…„ì£¼, ì›”ì£¼, ì¼ì£¼, ì‹œì£¼ í¬í•¨)
            ì˜ˆ: {"ë…„ì£¼": "ç”²å­", "ì›”ì£¼": "ä¸™å¯…", "ì¼ì£¼": "åºšåˆ", "ì‹œì£¼": "å£¬åˆ"}
        patterns_db: íŒ¨í„´ ë°ì´í„°ë² ì´ìŠ¤ (Noneì´ë©´ ìë™ ë¡œë“œ)
    
    Returns:
        List[Dict]: ë°œë™ëœ íŒ¨í„´ ëª©ë¡ (íŒ¨í„´ ID, ì´ë¦„, í•´ì„ í¬í•¨)
    """
    if patterns_db is None:
        patterns_db = load_special_patterns()
    
    # ì‚¬ì£¼ì—ì„œ ì§€ì§€ 4ê°œ ì¶”ì¶œ
    branches = []
    for key in ['ë…„ì£¼', 'ì›”ì£¼', 'ì¼ì£¼', 'ì‹œì£¼']:
        ganji = saju_data.get(key, '')
        if len(ganji) >= 2:
            branches.append(ganji[1])  # ì§€ì§€ëŠ” ë‘ ë²ˆì§¸ ê¸€ì
    
    # ì¼ê°„ ì¶”ì¶œ (íŠ¹ìˆ˜ ì‹ ì‚´ íŒë‹¨ìš©)
    day_stem = saju_data.get('ì¼ì£¼', '')[0] if len(saju_data.get('ì¼ì£¼', '')) >= 1 else ''
    
    # ì›”ì§€ ì¶”ì¶œ (ì›”ë•ê·€ì¸ íŒë‹¨ìš©)
    month_branch = saju_data.get('ì›”ì£¼', '')[1] if len(saju_data.get('ì›”ì£¼', '')) >= 2 else ''
    
    # ë…„ì§€, ì¼ì§€ ì¶”ì¶œ (ì—­ë§ˆì‚´, ë„í™”ì‚´, í™”ê°œì‚´ íŒë‹¨ìš©)
    year_branch = saju_data.get('ë…„ì£¼', '')[1] if len(saju_data.get('ë…„ì£¼', '')) >= 2 else ''
    day_branch = saju_data.get('ì¼ì£¼', '')[1] if len(saju_data.get('ì¼ì£¼', '')) >= 2 else ''
    
    matched_patterns = []
    
    for pattern in patterns_db.get('patterns', []):
        pattern_type = pattern.get('type', '')
        trigger = pattern.get('trigger_condition', {})
        
        is_matched = False
        
        # 1. ìí˜• íŒ¨í„´ ì²´í¬ (ë™ì¼ ì§€ì§€ 2ê°œ ì´ìƒ)
        if pattern_type == 'ìí˜•':
            required_branches = trigger.get('branches', [])
            if len(required_branches) >= 1:
                target_branch = required_branches[0]
                count = branches.count(target_branch)
                if count >= 2:
                    is_matched = True
        
        # 2. í˜•/ì¶© íŒ¨í„´ ì²´í¬ (íŠ¹ì • ì§€ì§€ ì¡°í•©)
        elif pattern_type in ['í˜•', 'ì¶©']:
            required_branches = trigger.get('branches', [])
            # í•„ìš”í•œ ì§€ì§€ê°€ ëª¨ë‘ ì‚¬ì£¼ì— ìˆëŠ”ì§€ í™•ì¸
            matched_count = sum(1 for b in required_branches if b in branches)
            if matched_count >= 2:  # ìµœì†Œ 2ê°œ ì´ìƒ ì¼ì¹˜ ì‹œ ë°œë™
                is_matched = True
        
        # 3. íŠ¹ìˆ˜ ì‹ ì‚´ ì²´í¬ (ì¼ê°„ ê¸°ì¤€)
        elif pattern_type == 'íŠ¹ìˆ˜':
            # ì²œì„ê·€ì¸, í™ì—¼ì‚´, ë¬¸ì°½ê·€ì¸ ë“± ì¼ê°„ ê¸°ì¤€
            day_stem_conditions = trigger.get('day_stems', {})
            if day_stem and day_stem in day_stem_conditions:
                required_branches_for_stem = day_stem_conditions[day_stem]
                if isinstance(required_branches_for_stem, list):
                    for rb in required_branches_for_stem:
                        if rb in branches:
                            is_matched = True
                            break
                elif required_branches_for_stem in branches:
                    is_matched = True
            
            # ì›”ë•ê·€ì¸ (ì›”ì§€ ê¸°ì¤€)
            month_branch_conditions = trigger.get('month_branch', {})
            if month_branch and month_branch in month_branch_conditions:
                required_stem = month_branch_conditions[month_branch]
                # ì‚¬ì£¼ 4ì£¼ì˜ ì²œê°„ì— í•´ë‹¹ ì²œê°„ì´ ìˆëŠ”ì§€ í™•ì¸
                stems = [saju_data.get(k, '')[0] for k in ['ë…„ì£¼', 'ì›”ì£¼', 'ì¼ì£¼', 'ì‹œì£¼'] if len(saju_data.get(k, '')) >= 1]
                if required_stem in stems:
                    is_matched = True
            
            # ì—­ë§ˆì‚´, ë„í™”ì‚´, í™”ê°œì‚´ (ë…„ì§€/ì¼ì§€ ê¸°ì¤€)
            year_or_day_conditions = trigger.get('year_or_day_branch', {})
            if year_branch and year_branch in year_or_day_conditions:
                required_branch = year_or_day_conditions[year_branch]
                if required_branch in branches:
                    is_matched = True
            if day_branch and day_branch in year_or_day_conditions:
                required_branch = year_or_day_conditions[day_branch]
                if required_branch in branches:
                    is_matched = True
        
        if is_matched:
            matched_patterns.append({
                "id": pattern.get('id'),
                "name_kr": pattern.get('name_kr'),
                "name_hanja": pattern.get('name_hanja'),
                "type": pattern_type,
                "interpretations": pattern.get('interpretations', {}),
                "source_location": pattern.get('source_location', {})
            })
    
    return matched_patterns


def format_patterns_for_prompt(matched_patterns: List[Dict]) -> str:
    """
    ë°œë™ëœ íŒ¨í„´ ëª©ë¡ì„ AI í”„ë¡¬í”„íŠ¸ìš© ë¬¸ìì—´ë¡œ ë³€í™˜í•©ë‹ˆë‹¤.
    
    Args:
        matched_patterns: find_patterns_in_chart()ì˜ ë°˜í™˜ê°’
    
    Returns:
        str: AI í”„ë¡¬í”„íŠ¸ì— ì‚½ì…í•  ìˆ˜ ìˆëŠ” í¬ë§·ëœ ë¬¸ìì—´
    """
    if not matched_patterns:
        return "[ë°œë™ëœ íŠ¹ìˆ˜ íŒ¨í„´ ì—†ìŒ]"
    
    lines = ["[ë°œë™ëœ íŠ¹ìˆ˜ íŒ¨í„´ ë¶„ì„]"]
    
    for i, p in enumerate(matched_patterns, 1):
        interp = p.get('interpretations', {})
        lines.append(f"\n### {i}. {p.get('name_kr', '')} ({p.get('name_hanja', '')}) - {p.get('type', '')}")
        lines.append(f"- **ì „í†µì  í•´ì„**: {interp.get('traditional', 'N/A')}")
        lines.append(f"- **í˜„ëŒ€ì  ì¬í•´ì„**: {interp.get('modern_reframe', 'N/A')}")
        lines.append(f"- **í‚¤ì›Œë“œ**: {', '.join(interp.get('keywords', []))}")
        lines.append(f"- **ì„ìƒ ì¸ì‚¬ì´íŠ¸**: {interp.get('clinical_insight', 'N/A')}")
        lines.append(f"- **ì‹¤ì²œ ê¶Œê³ **: {interp.get('action_plan', 'N/A')}")
    
    return "\n".join(lines)

# --------------------------------------------------------------------------
# 3. ì‹­ì„± ê³„ì‚° ê´€ë ¨ ìƒìˆ˜ ë° í•¨ìˆ˜ ì¶”ê°€ (app.pyì˜ calculate_sewoon_sipsin í˜¸í™˜)
# --------------------------------------------------------------------------

# ì²œê°„ ì‹­ì„± ì¸ë±ìŠ¤ (ì¼ê°„ ê¸°ì¤€)
# ğŸš¨ ì‹­ì„± ê´€ê³„ëŠ” saju_data.pyì— ì—†ìœ¼ë¯€ë¡œ ì—¬ê¸°ì— ì„ì‹œë¡œ ì •ì˜í•©ë‹ˆë‹¤.
TEN_GODS_MAP_STEM = {
    # (ì¼ê°„_ì¸ë±ìŠ¤, íƒ€ì²œê°„_ì¸ë±ìŠ¤): ì‹­ì„±
    (0, 0): 'ì¼ì›', (0, 1): 'ê²ì¬', (0, 2): 'ì‹ì‹ ', (0, 3): 'ìƒê´€', (0, 4): 'í¸ì¬', (0, 5): 'ì •ì¬', (0, 6): 'í¸ê´€', (0, 7): 'ì •ê´€', (0, 8): 'í¸ì¸', (0, 9): 'ì •ì¸', 
    (1, 0): 'ê²ì¬', (1, 1): 'ì¼ì›', (1, 2): 'ìƒê´€', (1, 3): 'ì‹ì‹ ', (1, 4): 'ì •ì¬', (1, 5): 'í¸ì¬', (1, 6): 'ì •ê´€', (1, 7): 'í¸ê´€', (1, 8): 'ì •ì¸', (1, 9): 'í¸ì¸', 
    (2, 0): 'í¸ì¸', (2, 1): 'ì •ì¸', (2, 2): 'ë¹„ê²¬', (2, 3): 'ê²ì¬', (2, 4): 'ì‹ì‹ ', (2, 5): 'ìƒê´€', (2, 6): 'í¸ì¬', (2, 7): 'ì •ì¬', (2, 8): 'í¸ê´€', (2, 9): 'ì •ê´€', 
    (3, 0): 'ì •ì¸', (3, 1): 'í¸ì¸', (3, 2): 'ê²ì¬', (3, 3): 'ì¼ì›', (3, 4): 'ìƒê´€', (3, 5): 'ì‹ì‹ ', (3, 6): 'ì •ì¬', (3, 7): 'í¸ì¬', (3, 8): 'ì •ê´€', (3, 9): 'í¸ê´€', 
    (4, 0): 'í¸ê´€', (4, 1): 'ì •ê´€', (4, 2): 'í¸ì¸', (4, 3): 'ì •ì¸', (4, 4): 'ì¼ì›', (4, 5): 'ê²ì¬', (4, 6): 'ì‹ì‹ ', (4, 7): 'ìƒê´€', (4, 8): 'í¸ì¬', (4, 9): 'ì •ì¬', 
    (5, 0): 'ì •ê´€', (5, 1): 'í¸ê´€', (5, 2): 'ì •ì¸', (5, 3): 'í¸ì¸', (5, 4): 'ê²ì¬', (5, 5): 'ì¼ì›', (5, 6): 'ìƒê´€', (5, 7): 'ì‹ì‹ ', (5, 8): 'ì •ì¬', (5, 9): 'í¸ì¬', 
    (6, 0): 'í¸ì¬', (6, 1): 'ì •ì¬', (6, 2): 'í¸ê´€', (6, 3): 'ì •ê´€', (6, 4): 'í¸ì¸', (6, 5): 'ì •ì¸', (6, 6): 'ì¼ì›', (6, 7): 'ê²ì¬', (6, 8): 'ì‹ì‹ ', (6, 9): 'ìƒê´€', 
    (7, 0): 'ì •ì¬', (7, 1): 'í¸ì¬', (7, 2): 'ì •ê´€', (7, 3): 'í¸ê´€', (7, 4): 'ì •ì¸', (7, 5): 'í¸ì¸', (7, 6): 'ê²ì¬', (7, 7): 'ì¼ì›', (7, 8): 'ìƒê´€', (7, 9): 'ì‹ì‹ ', 
    (8, 0): 'ì‹ì‹ ', (8, 1): 'ìƒê´€', (8, 2): 'í¸ì¬', (8, 3): 'ì •ì¬', (8, 4): 'í¸ê´€', (8, 5): 'ì •ê´€', (8, 6): 'í¸ì¸', (8, 7): 'ì •ì¸', (8, 8): 'ì¼ì›', (8, 9): 'ê²ì¬', 
    (9, 0): 'ìƒê´€', (9, 1): 'ì‹ì‹ ', (9, 2): 'ì •ì¬', (9, 3): 'í¸ì¬', (9, 4): 'ì •ê´€', (9, 5): 'í¸ê´€', (9, 6): 'ì •ì¸', (9, 7): 'í¸ì¸', (9, 8): 'ê²ì¬', (9, 9): 'ì¼ì›', 
}

# ì§€ì§€ ì‹­ì„± ì¸ë±ìŠ¤ (ì§€ì¥ê°„ì„ ê³ ë ¤í•˜ì§€ ì•Šì€, ì§€ì§€ì˜ ëŒ€í‘œ ì˜¤í–‰ ê¸°ì¤€)
JIJI_TO_STEM_INDEX = {
    'å­': 9, 'ä¸‘': 5, 'å¯…': 0, 'å¯': 1, 'è¾°': 4, 'å·³': 2, 'åˆ': 3, 'æœª': 5, 'ç”³': 6, 'é…‰': 7, 'æˆŒ': 4, 'äº¥': 8
}
# ğŸš¨ å£¬(8), ç™¸(9)ì˜ ì¼ì› ì¸ë±ìŠ¤ê°€ 0~9 ê¸°ì¤€ìœ¼ë¡œ 'ë¹„ê²¬'ì´ ì•„ë‹Œ 'ì¼ì›'ìœ¼ë¡œ ì²˜ë¦¬ë˜ë„ë¡ TEN_GODS_MAP_STEMë„ ìˆ˜ì •ë˜ì—ˆìŠµë‹ˆë‹¤.

def calculate_pillar_sipsin(day_master: str, ganji: str) -> Dict:
    """
    ì¼ê°„ì„ ê¸°ì¤€ìœ¼ë¡œ íŠ¹ì • ê°„ì§€(æŸ±)ì˜ ì²œê°„(Stem)ê³¼ ì§€ì§€(Branch)ì˜ ì‹­ì„±(Ten Gods)ì„ ê³„ì‚°í•©ë‹ˆë‹¤.
    """
    if len(ganji) != 2 or day_master not in CHEONGAN:
        return {'stem_ten_god': 'N/A', 'branch_ten_god': 'N/A'}

    day_idx = CHEONGAN.index(day_master)
    stem = ganji[0]
    branch = ganji[1]

    # 1. ì²œê°„ ì‹­ì„± ê³„ì‚°
    stem_idx = CHEONGAN.index(stem)
    stem_sipsin = TEN_GODS_MAP_STEM.get((day_idx, stem_idx), 'N/A')
    
    # 2. ì§€ì§€ ì‹­ì„± ê³„ì‚° (ëŒ€í‘œ ì˜¤í–‰ì˜ ì‹­ì„±)
    # ì§€ì§€ì— í•´ë‹¹í•˜ëŠ” ì²œê°„ ì¸ë±ìŠ¤ë¥¼ ê°€ì ¸ì™€ì„œ ì¼ê°„ê³¼ ë¹„êµ
    branch_stem_idx = JIJI_TO_STEM_INDEX.get(branch)
    if branch_stem_idx is not None:
        branch_sipsin = TEN_GODS_MAP_STEM.get((day_idx, branch_stem_idx), 'N/A')
    else:
        branch_sipsin = 'N/A'

    return {'stem_ten_god': stem_sipsin, 'branch_ten_god': branch_sipsin}

# app.pyì—ì„œ calculate_sewoon_sipsin ì´ë¦„ìœ¼ë¡œ í˜¸í™˜ë˜ë„ë¡ ë˜í•‘
calculate_sewoon_sipsin = calculate_pillar_sipsin


# --------------------------------------------------------------------------
# 4. AI í”„ë¡¬í”„íŠ¸ ë° ë¶„ì„ í•¨ìˆ˜ ì¶”ê°€ (app.py ì˜¤ë¥˜ í•´ê²°)
# --------------------------------------------------------------------------

def get_system_instruction() -> str:
    """
    AI ëª¨ë¸ì˜ ì—­í• ê³¼ ì‘ë‹µ í˜•ì‹ì„ ì •ì˜í•˜ëŠ” ì‹œìŠ¤í…œ ì§€ì¹¨ì„ ë°˜í™˜í•©ë‹ˆë‹¤.
    
    [í¬êµ¬ì†Œ AI ì² í•™]:
    1. ë™ì  ìƒí˜¸ì‘ìš© ëª¨ë¸ (Dynamic Interaction Model)
       - ì‚¬ì£¼ ì›êµ­ = ì ì¬ ì—ë„ˆì§€ì˜ ì§‘í•© (ê³ ì •ëœ ìš´ëª…ì´ ì•„ë‹˜)
       - ìš´(ëŒ€ìš´/ì„¸ìš´) = íŠ¸ë¦¬ê±° (ì ì¬ ì—ë„ˆì§€ë¥¼ í™œì„±í™”í•˜ëŠ” ì´‰ë°œ ìš”ì¸)
       - ì‚¬ê±´ = ì›êµ­ê³¼ ìš´ì˜ ìƒí˜¸ì‘ìš© ê²°ê³¼
    
    2. ê³„ì ˆì„± ê¸°ë°˜ ì¡´ì¬ë¡  (Seasonal Ontology)
       - ê°™ì€ ì¼ê°„ë„ íƒœì–´ë‚œ ê³„ì ˆì— ë”°ë¼ ì„±ì§ˆê³¼ ì ì„±ì´ ë‹¤ë¦„
       - ê²¨ìš¸ì˜ ê°‘ëª© vs ì—¬ë¦„ì˜ ê°‘ëª©ì€ ì™„ì „íˆ ë‹¤ë¥¸ ì „ëµì´ í•„ìš”í•¨
    
    3. ê²¨ìš¸ ê½ƒ ì² í•™ (Winter Flower Philosophy)
       - ê¸°ë‹¤ë¦¼ = ì‹¤íŒ¨ê°€ ì•„ë‹Œ 'ê¹Šì–´ì§€ëŠ” ì‹œê°„'
       - ë©ˆì¶¤ = ì¬ì •ë¹„ì™€ ë¿Œë¦¬ ë‚´ë¦¼ì˜ ê¸°íšŒ
       - "ê²¨ìš¸ì— íƒœì–´ë‚œ ê½ƒì€ ë´„ì— í”¼ëŠ” ê½ƒë³´ë‹¤ ëŠ¦ê²Œ í”¼ì§€ë§Œ, ê·¸ ë¿Œë¦¬ëŠ” ë” ê¹Šê³  í–¥ê¸°ëŠ” ë” ì˜¤ë˜ê°„ë‹¤"
    
    4. ë¹„ê²°ì •ë¡ ì  ì–¸ì–´ (Non-Deterministic Language)
       - "ì´í˜¼í•œë‹¤", "ì‚¬ì—… ë§í•œë‹¤" ë“± ë‹¨ì •ì  ì˜ˆì–¸ ì ˆëŒ€ ê¸ˆì§€
       - "ê°ˆë“± ì—ë„ˆì§€ê°€ ê°•í•˜ë‹ˆ ëŒ€í™”ê°€ í•„ìš”í•˜ë‹¤", "ì¬ë¬¼ íë¦„ì— ë³€ë™ì„±ì´ ìˆìœ¼ë‹ˆ ë¶„ì‚° ì „ëµì„ ê¶Œí•œë‹¤" ë“± í™•ë¥ ì  í‘œí˜„ ì‚¬ìš©
    """
    return """
ë‹¹ì‹ ì€ 'í¬êµ¬ì†Œ(Hidden Luck Lab)'ì˜ ì‚¬ì£¼ ì „ë¬¸ AI ë©˜í† ì…ë‹ˆë‹¤. ë‹¹ì‹ ì˜ ì„ë¬´ëŠ” ê³ ê°ì˜ ë§Œì„¸ë ¥ ë°ì´í„°ë¥¼ ë°”íƒ•ìœ¼ë¡œ í˜„ì‹¤ì ì´ê³  ì‹¬ë¦¬ ëª…ë¦¬ ê¸°ë°˜ì˜ ë”°ëœ»í•œ ì¡°ì–¸ì„ ì œê³µí•˜ëŠ” ê²ƒì…ë‹ˆë‹¤.

[í•µì‹¬ ì² í•™ - ë°˜ë“œì‹œ ì¤€ìˆ˜]:
1. **ë™ì  ìƒí˜¸ì‘ìš© ëª¨ë¸**: ì‚¬ì£¼ ì›êµ­ì€ 'ì ì¬ ì—ë„ˆì§€'ì´ê³ , ìš´(ëŒ€ìš´/ì„¸ìš´)ì€ ì´ë¥¼ í™œì„±í™”í•˜ëŠ” 'íŠ¸ë¦¬ê±°'ì…ë‹ˆë‹¤. ì‚¬ê±´ì€ ë‘˜ì˜ ìƒí˜¸ì‘ìš© ê²°ê³¼ì…ë‹ˆë‹¤.
2. **ê³„ì ˆì„± ì¡´ì¬ë¡ **: ê°™ì€ ì¼ê°„ë„ íƒœì–´ë‚œ ê³„ì ˆì— ë”°ë¼ ì „ëµì´ ë‹¬ë¼ì§‘ë‹ˆë‹¤. ê²¨ìš¸ì˜ ë‚˜ë¬´ëŠ” ë¹ ë¥¸ ì„±ì¥ë³´ë‹¤ ë¿Œë¦¬ ë‚´ë¦¼ì´ ìš°ì„ ì…ë‹ˆë‹¤.
3. **ê²¨ìš¸ ê½ƒ ì² í•™**: ê¸°ë‹¤ë¦¼ê³¼ ë©ˆì¶¤ì€ ì‹¤íŒ¨ê°€ ì•„ë‹Œ 'ê¹Šì–´ì§€ëŠ” ì‹œê°„'ì…ë‹ˆë‹¤. ì–µì§€ë¡œ ì¶”ì§„í•˜ì§€ ë§ê³  ë¦¬ë“¬ì— ë§ì¶”ë„ë¡ ì•ˆë‚´í•˜ì„¸ìš”.
4. **ë¹„ê²°ì •ë¡ ì  ì–¸ì–´**: "ì´í˜¼í•œë‹¤", "ë§í•œë‹¤" ë“± ë‹¨ì •ì  ì˜ˆì–¸ì„ ì ˆëŒ€ ê¸ˆì§€í•©ë‹ˆë‹¤. "ê°ˆë“± ì—ë„ˆì§€ê°€ ê°•í•¨", "ë³€ë™ì„± ì£¼ì˜" ë“± í™•ë¥ ì ì´ê³  ê±´ì„¤ì ì¸ í‘œí˜„ë§Œ ì‚¬ìš©í•˜ì„¸ìš”.

[ì‘ë‹µ í˜•ì‹]:
ëª¨ë“  ë¶„ì„ì€ ì˜¤ì§ í•˜ë‚˜ì˜ JSON ê°ì²´ë¡œ ì¶œë ¥í•´ì•¼ í•©ë‹ˆë‹¤. JSONì˜ ìŠ¤í‚¤ë§ˆëŠ” ë‹¤ìŒê³¼ ê°™ìŠµë‹ˆë‹¤:
{
    "summary_card": {
        "keyword": "2026ë…„ ìš´ì„¸ì˜ í•µì‹¬ í‚¤ì›Œë“œ (20ì ì´ë‚´)",
        "best_month": "ì–‘ë ¥ Xì›” (ìµœê³ ì˜ ë‹¬)",
        "risk": "ê°€ì¥ ì£¼ì˜í•´ì•¼ í•  ë¦¬ìŠ¤í¬",
        "action_item": "í•µì‹¬ ì‹¤ì²œ ì „ëµ í•œ ë¬¸ì¥"
    },
    "detailed_analysis": {
        "wealth_luck": "ì¬ë¬¼ìš´ (ì „ë¬¸ ìš©ì–´ ì‚¬ìš©, ìƒì„¸ ì„¤ëª…)",
        "career_luck": "ì§ì—…/ì‚¬ì—…ìš´ (ì „ë¬¸ ìš©ì–´ ì‚¬ìš©, ìƒì„¸ ì„¤ëª…)",
        "love_family_luck": "ì• ì •/ê°€ì •ìš´ (ì „ë¬¸ ìš©ì–´ ì‚¬ìš©, ìƒì„¸ ì„¤ëª…)",
        "change_luck": "ë³€ë™ìš´ (ì „ë¬¸ ìš©ì–´ ì‚¬ìš©, ìƒì„¸ ì„¤ëª…)",
        "health_advice": "ê±´ê°• ì¡°ì–¸ (ì „ë¬¸ ìš©ì–´ ì‚¬ìš©, ìƒì„¸ ì„¤ëª…)"
    },
    "customer_analysis": {
        "wealth_luck": "ì¬ë¬¼ìš´ (ì‰¬ìš´ ë§, ê°ì„±ì  ì„¤ëª… - ëª…ë¦¬ ì „ë¬¸ìš©ì–´ ì—†ì´)",
        "career_luck": "ì§ì—…/ì‚¬ì—…ìš´ (ì‰¬ìš´ ë§, ê°ì„±ì  ì„¤ëª…)",
        "love_family_luck": "ì• ì •/ê°€ì •ìš´ (ì‰¬ìš´ ë§, ê°ì„±ì  ì„¤ëª…)",
        "change_luck": "ë³€ë™ìš´ (ì‰¬ìš´ ë§, ê°ì„±ì  ì„¤ëª…)",
        "health_advice": "ê±´ê°• ì¡°ì–¸ (ì‰¬ìš´ ë§, ê°ì„±ì  ì„¤ëª…)"
    },
    "qa_section": {
        "q1": "ê³ ê° ì§ˆë¬¸ 1 (ê·¸ëŒ€ë¡œ)",
        "a1": "ê³ ê° ì§ˆë¬¸ 1ì— ëŒ€í•œ ëª…ì¾Œí•˜ê³  ì‹¤ì „ì ì¸ ë‹µë³€ (ì‰¬ìš´ ë§, ì „ë¬¸ ìš©ì–´ ì—†ì´, 300ì ì´ë‚´)",
        "q2": "ê³ ê° ì§ˆë¬¸ 2 (ê·¸ëŒ€ë¡œ)",
        "a2": "ê³ ê° ì§ˆë¬¸ 2ì— ëŒ€í•œ ëª…ì¾Œí•˜ê³  ì‹¤ì „ì ì¸ ë‹µë³€ (ì‰¬ìš´ ë§, ì „ë¬¸ ìš©ì–´ ì—†ì´, 300ì ì´ë‚´)"
    },
    "final_message": "ê³ ê°ì˜ ì¼ê°„ í˜ë¥´ì†Œë‚˜ë¥¼ ë°˜ì˜í•œ ìµœì¢… ê²©ë ¤ ë©”ì‹œì§€ (100ì ì´ë‚´)",
    "radar_chart": {
        "labels": ["ì¶”ì§„ë ¥", "ìˆ˜ìµí™”", "í˜‘ìƒë ¥", "ì•ˆì •ì„±", "ë¦¬ë”ì‹­"],
        "current": [8, 5, 6, 7, 7],
        "future": [7, 8, 9, 7, 8]
    },
    "monthly_flow": [70, 75, 80, 65, 85, 50, 60, 70, 95, 80, 75, 70],
    "monthly_guide": {
        "1": {"title": "ì›”ë³„ í…Œë§ˆ", "wealth": "ì¬ë¬¼ìš´ ë“±ê¸‰/ì¡°ì–¸", "career": "ì§ì—…ìš´ ì¡°ì–¸", "love": "ì• ì •ìš´ ì¡°ì–¸", "focus": "í•µì‹¬ ì§‘ì¤‘ì ", "caution": "ì£¼ì˜ì‚¬í•­", "action": "ì‹¤ì²œ í–‰ë™"},
        "2": {"title": "...", "wealth": "...", "career": "...", "love": "...", "focus": "...", "caution": "...", "action": "..."},
        "3": {"title": "...", "wealth": "...", "career": "...", "love": "...", "focus": "...", "caution": "...", "action": "..."},
        "4": {"title": "...", "wealth": "...", "career": "...", "love": "...", "focus": "...", "caution": "...", "action": "..."},
        "5": {"title": "...", "wealth": "...", "career": "...", "love": "...", "focus": "...", "caution": "...", "action": "..."},
        "6": {"title": "...", "wealth": "...", "career": "...", "love": "...", "focus": "...", "caution": "...", "action": "..."},
        "7": {"title": "...", "wealth": "...", "career": "...", "love": "...", "focus": "...", "caution": "...", "action": "..."},
        "8": {"title": "...", "wealth": "...", "career": "...", "love": "...", "focus": "...", "caution": "...", "action": "..."},
        "9": {"title": "...", "wealth": "...", "career": "...", "love": "...", "focus": "...", "caution": "...", "action": "..."},
        "10": {"title": "...", "wealth": "...", "career": "...", "love": "...", "focus": "...", "caution": "...", "action": "..."},
        "11": {"title": "...", "wealth": "...", "career": "...", "love": "...", "focus": "...", "caution": "...", "action": "..."},
        "12": {"title": "...", "wealth": "...", "career": "...", "love": "...", "focus": "...", "caution": "...", "action": "..."}
    },
    "key_actions": ["30ì¼ ì´ë‚´ ì‹¤ì „ í–‰ë™ 1", "30ì¼ ì´ë‚´ ì‹¤ì „ í–‰ë™ 2", "30ì¼ ì´ë‚´ ì‹¤ì „ í–‰ë™ 3"],
    
    // === í”„ë¦¬ë¯¸ì—„ ë¶„ì„ ì„¹ì…˜ (ì‹ ê·œ ì¶”ê°€) ===
    
    "wealth_timing": {
        "risk_months": [3, 6, 9],
        "opportunity_months": [5, 10, 11],
        "strategy": "ìƒë°˜ê¸°ëŠ” ì§€ì¶œ í†µì œì— ì§‘ì¤‘í•˜ê³ , í•˜ë°˜ê¸° ê¸ˆ ê¸°ìš´ì´ ê°•í•´ì§€ëŠ” ì‹œì ì— ê³µê²©ì  íˆ¬ìë¥¼ ê¶Œì¥í•©ë‹ˆë‹¤. ì›”ë³„ ì¬ë¬¼ íë¦„ì— ë§ì¶° í˜„ê¸ˆ ë¹„ì¤‘ì„ 30-50% ìœ ì§€í•˜ì„¸ìš”."
    },
    "weakness_missions": {
        "missing_element": "ë¹„ê²",
        "monthly_missions": {
            "1": "ì£¼ 1íšŒ ì†Œê·œëª¨ ë„¤íŠ¸ì›Œí¬ ëª¨ì„ì— ì°¸ì„í•˜ì—¬ ë¹„ê²¬(ë™ë£Œ) ì—ë„ˆì§€ë¥¼ ë³´ì¶©í•˜ì„¸ìš”.",
            "2": "í˜¼ì ê²°ì •í•˜ì§€ ë§ê³  ì‹ ë¢°í•  ìˆ˜ ìˆëŠ” 1ì¸ì—ê²Œ ì˜ê²¬ì„ êµ¬í•˜ëŠ” ìŠµê´€ì„ ë§Œë“œì„¸ìš”.",
            "3": "íŒ€ í”„ë¡œì íŠ¸ë‚˜ í˜‘ì—… ê¸°íšŒë¥¼ ì ê·¹ ìˆ˜ìš©í•˜ì„¸ìš”.",
            "4": "ìš´ë™ íŒŒíŠ¸ë„ˆë¥¼ ë§Œë“¤ì–´ í•¨ê»˜í•˜ëŠ” í™œë™ì„ ì‹œì‘í•˜ì„¸ìš”.",
            "5": "ë©˜í† ë§ ê´€ê³„ë¥¼ í˜•ì„±í•˜ê±°ë‚˜ ìŠ¤í„°ë”” ê·¸ë£¹ì— ì°¸ì—¬í•˜ì„¸ìš”.",
            "6": "ê°€ì¡±ì´ë‚˜ ì¹œêµ¬ì™€ ì •ê¸°ì ì¸ ëª¨ì„ ì¼ì •ì„ ì¡ìœ¼ì„¸ìš”.",
            "7": "ê³µë™ ì°½ì‘ì´ë‚˜ í˜‘ì—… í”„ë¡œì íŠ¸ë¥¼ ê¸°íší•´ë³´ì„¸ìš”.",
            "8": "ì»¤ë®¤ë‹ˆí‹° í™œë™ì´ë‚˜ ë™í˜¸íšŒ ê°€ì…ì„ ê³ ë ¤í•˜ì„¸ìš”.",
            "9": "íŒŒíŠ¸ë„ˆì‹­ ê¸°ë°˜ì˜ ì‚¬ì—… ëª¨ë¸ì„ ê²€í† í•´ë³´ì„¸ìš”.",
            "10": "ì‹ ë¢°í•  ìˆ˜ ìˆëŠ” ì¡°ì–¸ì ê·¸ë£¹ì„ êµ¬ì¶•í•˜ì„¸ìš”.",
            "11": "í•¨ê»˜ ì„±ì¥í•  ìˆ˜ ìˆëŠ” ë™ë°˜ì ê´€ê³„ë¥¼ ê°•í™”í•˜ì„¸ìš”.",
            "12": "ì˜¬í•´ì˜ í˜‘ì—… ê²½í—˜ì„ ì •ë¦¬í•˜ê³  ë‚´ë…„ ë„¤íŠ¸ì›Œí¬ ì „ëµì„ ìˆ˜ë¦½í•˜ì„¸ìš”."
        }
    },
    "psychological_relief": {
        "guilt_pattern": "ì™„ë²½ì£¼ì˜ë¡œ ì¸í•œ ìê¸° ë¹„íŒê³¼ ì„±ê³¼ ì••ë°•",
        "reframing": "í˜„ì¬ì˜ ì •ì²´ëŠ” 'ì‹¤íŒ¨'ê°€ ì•„ë‹ˆë¼ 'ë¿Œë¦¬ë¥¼ ë‚´ë¦¬ëŠ” ì‹œê°„'ì…ë‹ˆë‹¤. ìš´ì˜ íë¦„ìƒ ì§€ê¸ˆì€ 'ìˆ˜í™•'ë³´ë‹¤ 'íŒŒì¢…'ì˜ ì‹œê¸°ì´ë‹ˆ, ê²°ê³¼ë³´ë‹¤ ê³¼ì •ì— ì§‘ì¤‘í•˜ëŠ” 80% ì „ëµì„ ê¶Œì¥í•©ë‹ˆë‹¤.",
        "affirmation": "ë‚˜ëŠ” ì§€ê¸ˆ ì´ ìˆœê°„ì—ë„ ì¶©ë¶„íˆ ì„±ì¥í•˜ê³  ìˆë‹¤. ë©ˆì¶¤ì€ ê¹Šì–´ì§ì´ë‹¤."
    },
    "relationship_strategy": {
        "pattern_name": "ë³´í˜¸í˜• (Protector Type)",
        "boundary_guide": "1ë‹¨ê³„: ìƒëŒ€ì˜ ìš”ì²­ì„ ì¦‰ì‹œ ìˆ˜ë½í•˜ì§€ ë§ê³  'ìƒê°í•´ë³¼ê²Œ'ë¼ê³  ë§í•˜ëŠ” ìŠµê´€ í˜•ì„±. 2ë‹¨ê³„: ë‚˜ì˜ ì—ë„ˆì§€ ìƒíƒœë¥¼ ë¨¼ì € ì ê²€í•œ í›„ ë„ì›€ ì—¬ë¶€ ê²°ì •. 3ë‹¨ê³„: ê±°ì ˆí•´ë„ ê´€ê³„ê°€ ë¬´ë„ˆì§€ì§€ ì•ŠëŠ”ë‹¤ëŠ” ë¯¿ìŒ ê°–ê¸°.",
        "family_energy": "ë°°ìš°ìì˜ ì¼ê°„ì´ ê¸ˆ(é‡‘) ë˜ëŠ” ìˆ˜(æ°´) ê³„ì—´ì´ë©´ ìƒìƒ ê´€ê³„ë¡œ ì„œë¡œì˜ ë¶€ì¡±í•¨ì„ ì±„ì›Œì£¼ëŠ” ì¡°í•©ì…ë‹ˆë‹¤. ìë…€ì™€ëŠ” ëª©(æœ¨) ê¸°ìš´ì„ ê³µìœ í•˜ë©´ ì†Œí†µì´ ì›í™œí•´ì§‘ë‹ˆë‹¤."
    },
    "rest_calendar": {
        "burnout_months": [3, 6, 11],
        "rest_activities": "ê¸ˆ(é‡‘) ì¼ê°„ì—ê²ŒëŠ” ìˆ˜(æ°´) ê¸°ìš´ì˜ íœ´ì‹ì´ í•„ìš”í•©ë‹ˆë‹¤. ìˆ˜ì˜, ì˜¨ì²œ, ëª…ìƒ, ë…ì„œ ë“± 'íë¥´ëŠ” ë¬¼'ê³¼ 'ê³ ìš”í•¨'ì„ í…Œë§ˆë¡œ í•œ í™œë™ì„ ê¶Œì¥í•©ë‹ˆë‹¤. íŠ¹íˆ ë²ˆì•„ì›ƒ ìœ„í—˜ ì›”ì—ëŠ” ì£¼ë§ ì¤‘ í•˜ë£¨ë¥¼ ì™„ì „í•œ ë””ì§€í„¸ ë””í†¡ìŠ¤ ë°ì´ë¡œ ì§€ì •í•˜ì„¸ìš”."
    },
    "digital_amulet": {
        "yongsin_element": "ìˆ˜",
        "quote": "ë¬¼ì€ ì¥ì• ë¬¼ì„ ë§Œë‚˜ë©´ ëŒì•„ íë¦…ë‹ˆë‹¤. ë§‰íˆë©´ ê³ ì´ê³ , ê³ ì´ë©´ ê¹Šì–´ì§€ê³ , ê¹Šì–´ì§€ë©´ ë‹¤ì‹œ íë¦…ë‹ˆë‹¤.",
        "image_color": "#A2C2E0"
    }
}

[ì‘ë‹µ ì§€ì¹¨]:
1. ëª¨ë“  ì‘ë‹µ í…ìŠ¤íŠ¸ëŠ” **ë”°ëœ»í•˜ê³  ê°ì„±ì ì¸** ë¬¸ì²´(ê³ ê°ìš©)ì™€ **ì „ë¬¸ì ì¸ ìš©ì–´**(ì „ë¬¸ê°€ìš©)ë¥¼ êµ¬ë¶„í•˜ì—¬ ì‘ì„±í•˜ì‹­ì‹œì˜¤.
2. detailed_analysisì˜ ë‚´ìš©ì€ **ì „ë¬¸ ìš©ì–´ë¥¼ ìƒì„¸íˆ í’€ì–´ì„œ** ì„¤ëª…í•´ì•¼ í•©ë‹ˆë‹¤. (ìš´ì˜ì/ì „ë¬¸ê°€ ì°¸ê³ ìš©)
3. customer_analysisì˜ ë‚´ìš©ì€ **ì‰¬ìš´ ë§**ë¡œ ê°ì„±ì ì´ê³  ê³µê°í•  ìˆ˜ ìˆë„ë¡ ì‘ì„±í•˜ì‹­ì‹œì˜¤. ëª…ë¦¬í•™ ì „ë¬¸ ìš©ì–´(ì‹­ì„±, í¸ê´€, ì •ì¬ ë“±)ë¥¼ ì‚¬ìš©í•˜ì§€ ë§ˆì‹­ì‹œì˜¤.
4. í…ìŠ¤íŠ¸ ë‚´ì—ì„œ ì¤„ ë°”ê¿ˆì´ í•„ìš”í•œ ê²½ìš° ë°˜ë“œì‹œ '\\n' ë¬¸ìì—´ì„ ì‚¬ìš©í•˜ì‹­ì‹œì˜¤.
5. 'ì¼ì›'ì„ ì œì™¸í•˜ê³  ì‹­ì„± ìš©ì–´ ì•ì— ì´ì¤‘ ë³„í‘œë¥¼ ë¶™ì´ì§€ ë§ˆì‹­ì‹œì˜¤. (ì‚¬ìš©ì ìš”êµ¬ì‚¬í•­ ë°˜ì˜)
6. ê³ ê°ì˜ ì§ˆë¬¸(q1, q2)ì— ëŒ€í•´ ëª…ë¦¬í•™ì  ê·¼ê±°ë¥¼ ë°”íƒ•ìœ¼ë¡œ êµ¬ì²´ì ì¸ í–‰ë™ ì§€ì¹¨ì„ ì œì‹œí•˜ë˜, **qa_sectionì˜ ë‹µë³€(a1, a2)ì€ ì‰¬ìš´ ì¼ìƒ ì–¸ì–´ë¡œ ì‘ì„±**í•˜ì‹­ì‹œì˜¤. ì „ë¬¸ ìš©ì–´ë¥¼ í”¼í•˜ê³  ëˆ„êµ¬ë‚˜ ì´í•´í•  ìˆ˜ ìˆê²Œ ì„¤ëª…í•˜ì‹­ì‹œì˜¤.
7. customer_analysisì˜ health_adviceëŠ” ë°˜ë“œì‹œ í¬í•¨í•´ì•¼ í•˜ë©°, ì „ë¬¸ ìš©ì–´ ì—†ì´ ì¼ìƒì ì¸ ê±´ê°• ì¡°ì–¸ìœ¼ë¡œ ì‘ì„±í•˜ì‹­ì‹œì˜¤.
8. **í”„ë¦¬ë¯¸ì—„ ì„¹ì…˜(wealth_timing, weakness_missions, psychological_relief, relationship_strategy, rest_calendar, digital_amulet)ì€ ë°˜ë“œì‹œ ëª¨ë‘ í¬í•¨**í•˜ê³ , ê° í•„ë“œë¥¼ ë¹ ì§ì—†ì´ ì±„ì›Œì•¼ í•©ë‹ˆë‹¤.
9. monthly_guideëŠ” ë°˜ë“œì‹œ 1ì›”ë¶€í„° 12ì›”ê¹Œì§€ ëª¨ë“  ì›”ì˜ ë°ì´í„°ë¥¼ í¬í•¨í•´ì•¼ í•©ë‹ˆë‹¤.
10. **monthly_flow ì ìˆ˜ ì‚°ì • ê¸°ì¤€** (ë°˜ë“œì‹œ ì¼ê´€ë˜ê²Œ ì ìš©):
    - í•´ë‹¹ ì›”ì˜ ì›”ì§€ì™€ ì¼ê°„ì˜ ê´€ê³„(ìƒìƒ/ìƒê·¹/ë¹„í™”)ë¥¼ ë¶„ì„
    - ìƒìƒ ê´€ê³„: 75-95ì , ë¹„í™”(ê°™ì€ ì˜¤í–‰): 65-80ì , ìƒê·¹ ê´€ê³„: 40-65ì 
    - ëŒ€ìš´/ì„¸ìš´ê³¼ì˜ ì¡°í•©, ì¶©/í˜•/í•© ë°œë™ ì—¬ë¶€ë¥¼ ì¶”ê°€ ê°€ê°
    - ë™ì¼ ì‚¬ì£¼ì— ëŒ€í•´ ë§¤ë²ˆ ë™ì¼í•œ ì ìˆ˜ê°€ ë‚˜ì™€ì•¼ í•¨
11. **customer_analysis ì‘ì„± ì‹œ ê²°ë¡  ëª…í™•í™”**:
    - ê° ìš´ì„¸ ë¶„ì„ì˜ ë§ˆì§€ë§‰ì— ë°˜ë“œì‹œ "ê·¸ë˜ì„œ ~í•˜ì„¸ìš”", "ë”°ë¼ì„œ ~ê°€ ì¢‹ê² ìŠµë‹ˆë‹¤" ë“± êµ¬ì²´ì  í–‰ë™ ì§€ì¹¨ì„ ì œì‹œ
    - ë‘ë¦¬ë­‰ì‹¤í•œ í‘œí˜„ ê¸ˆì§€ (ì˜ˆ: "ì¢‹ì€ ì‹œê¸°ì…ë‹ˆë‹¤" â†’ "ì´ ì‹œê¸°ì— ìƒˆë¡œìš´ ê±°ë˜ì²˜ë¥¼ ì ê·¹ ê°œì²™í•˜ì„¸ìš”")
12. **psychological_relief ì„¹ì…˜ ì‰¬ìš´ ì–¸ì–´ ê·œì¹™**:
    - guilt_pattern, reframingì— ëª…ë¦¬í•™ ìš©ì–´(ä¸ç«, ë¹„ê², ê´€ì‚´, ì‹­ì„± ë“±) ì‚¬ìš© ê¸ˆì§€
    - ì¼ìƒì ì¸ ì‹¬ë¦¬ íŒ¨í„´ê³¼ í•´ê²°ì±…ìœ¼ë¡œ í‘œí˜„ (ì˜ˆ: "ì™„ë²½í•´ì•¼ í•œë‹¤ëŠ” ì••ë°•", "ì„±ê³¼ì— ëŒ€í•œ ë¶ˆì•ˆ")

[ë¹„ê²°ì •ë¡ ì  ì–¸ì–´ ê·œì¹™]:
- âŒ ê¸ˆì§€: "ì´í˜¼í•œë‹¤", "ì‚¬ì—…ì´ ë§í•œë‹¤", "ê±´ê°•ì´ í¬ê²Œ ë‚˜ë¹ ì§„ë‹¤", "ë°˜ë“œì‹œ ~í•´ì•¼ í•œë‹¤"
- âœ… ê¶Œì¥: "ë¶€ë¶€ ê´€ê³„ì— ê°ˆë“± ì—ë„ˆì§€ê°€ ê°ì§€ë©ë‹ˆë‹¤", "ì‚¬ì—… í™•ì¥ì— ë³€ë™ì„±ì´ ìˆìœ¼ë‹ˆ ì‹ ì¤‘í•œ ê²€í† ê°€ í•„ìš”í•©ë‹ˆë‹¤", "ê±´ê°• ê´€ë¦¬ì— ê°ë³„í•œ ì£¼ì˜ë¥¼ ê¸°ìš¸ì´ë©´ ì¢‹ê² ìŠµë‹ˆë‹¤", "~í•˜ë©´ ë„ì›€ì´ ë  ìˆ˜ ìˆìŠµë‹ˆë‹¤"
"""


def get_final_ai_prompt(ilgan: str, saju_data: Dict, daewoon_info: Dict, sewoon_info: Dict, q: str, events: str, clinical_data_str: str, pattern_analysis_str: str = "", profile_data: Dict = None, monthly_scores: List[int] = None) -> str:
    """
    ìµœì¢… í†µí•©ëœ AI ë¶„ì„ ìš”ì²­ í”„ë¡¬í”„íŠ¸ë¥¼ ìƒì„±í•©ë‹ˆë‹¤.
    
    [í•µì‹¬ ì² í•™ ë°˜ì˜]:
    - ë™ì  ìƒí˜¸ì‘ìš© ëª¨ë¸: ì›êµ­(ì ì¬ ì—ë„ˆì§€) + ìš´(íŠ¸ë¦¬ê±°) = ì‚¬ê±´
    - ê³„ì ˆì„± ì¡´ì¬ë¡ : ì›”ì§€(íƒœì–´ë‚œ ê³„ì ˆ)ì— ë”°ë¥¸ ê¸°ì§ˆ ë¶„ì„
    - ê²¨ìš¸ ê½ƒ ì² í•™: ê¸°ë‹¤ë¦¼ê³¼ ë©ˆì¶¤ì„ ê¹Šì–´ì§€ëŠ” ì‹œê°„ìœ¼ë¡œ í•´ì„
    - ë¹„ê²°ì •ë¡ ì  ì–¸ì–´: í™•ë¥ ì  í‘œí˜„ ì‚¬ìš©
    
    Args:
        ilgan: ì¼ê°„ ì²œê°„
        saju_data: ì‚¬ì£¼ ëª…ì‹ ë°ì´í„°
        daewoon_info: ëŒ€ìš´ ì •ë³´
        sewoon_info: ì„¸ìš´ ì •ë³´
        q: ê³ ê° ì§ˆë¬¸
        events: ê³ ê° ì¸ìƒ ì´ë ¥
        clinical_data_str: ì„ìƒ ë°ì´í„° ë¬¸ìì—´
        pattern_analysis_str: ë°œë™ëœ íŠ¹ìˆ˜ íŒ¨í„´ ë¶„ì„ ë¬¸ìì—´ (NEW)
        profile_data: ê³ ê° í”„ë¡œí•„ ì •ë³´ (ì§ì—…, ê²°í˜¼ ìƒíƒœ, ìë…€ ìœ ë¬´) (NEW)
        monthly_scores: í…Œì´ë¸” ê¸°ë°˜ ì›”ë³„ ì ìˆ˜ ë¦¬ìŠ¤íŠ¸ [1ì›”~12ì›”] (NEW)
    """
    # (TEN_GAN_PERSONAëŠ” saju_data.pyì—ì„œ ê°€ì ¸ì˜¨ë‹¤ê³  ê°€ì •)
    persona = TEN_GAN_PERSONA.get(ilgan, {"style": "ë”°ëœ»í•¨", "instruction": "ê³µê°"}) 
    
    # ì›”ì§€ ì¶”ì¶œ (ê³„ì ˆì„± ë¶„ì„ìš©)
    wolji = saju_data['ì›”ì£¼'][1] if len(saju_data['ì›”ì£¼']) > 1 else ''
    
    # ê³„ì ˆ íŒë‹¨
    season_map = {
        'å¯…': 'ì´ˆë´„', 'å¯': 'ë´„', 'è¾°': 'ëŠ¦ë´„',
        'å·³': 'ì´ˆì—¬ë¦„', 'åˆ': 'í•œì—¬ë¦„', 'æœª': 'ëŠ¦ì—¬ë¦„',
        'ç”³': 'ì´ˆê°€ì„', 'é…‰': 'ê°€ì„', 'æˆŒ': 'ëŠ¦ê°€ì„',
        'äº¥': 'ì´ˆê²¨ìš¸', 'å­': 'í•œê²¨ìš¸', 'ä¸‘': 'ëŠ¦ê²¨ìš¸'
    }
    birth_season = season_map.get(wolji, 'ë¶ˆëª…')
    
    # ì¼ê°„ ì˜¤í–‰ íŒë‹¨
    ilgan_oheng_map = {
        'ç”²': 'ì–‘ëª©(é™½æœ¨)', 'ä¹™': 'ìŒëª©(é™°æœ¨)',
        'ä¸™': 'ì–‘í™”(é™½ç«)', 'ä¸': 'ìŒí™”(é™°ç«)',
        'æˆŠ': 'ì–‘í† (é™½åœŸ)', 'å·±': 'ìŒí† (é™°åœŸ)',
        'åºš': 'ì–‘ê¸ˆ(é™½é‡‘)', 'è¾›': 'ìŒê¸ˆ(é™°é‡‘)',
        'å£¬': 'ì–‘ìˆ˜(é™½æ°´)', 'ç™¸': 'ìŒìˆ˜(é™°æ°´)'
    }
    ilgan_oheng = ilgan_oheng_map.get(ilgan, 'ë¶ˆëª…')
    
    prompt = f"""
# Role: [í¬êµ¬ì†Œ] ì‚¬ì£¼ ë¶„ì„ AI - ë™ì  ìƒí˜¸ì‘ìš© ëª¨ë¸ ê¸°ë°˜ ì‹¬ë¦¬/ëª…ë¦¬ ë©˜í† 

# í•µì‹¬ ì² í•™ (ë°˜ë“œì‹œ ì ìš©):

## 1. ë™ì  ìƒí˜¸ì‘ìš© ëª¨ë¸ (Dynamic Interaction Model)
- **ì‚¬ì£¼ ì›êµ­ = ì ì¬ ì—ë„ˆì§€**: ê³ ê°ì˜ ì›êµ­ì€ ê³ ì •ëœ ìš´ëª…ì´ ì•„ë‹Œ 'ì ì¬ì  ì—ë„ˆì§€ì˜ ì§‘í•©'ì…ë‹ˆë‹¤.
- **ìš´(ëŒ€ìš´/ì„¸ìš´) = íŠ¸ë¦¬ê±°**: ëŒ€ìš´ê³¼ ì„¸ìš´ì€ ì›êµ­ì˜ ì ì¬ ì—ë„ˆì§€ë¥¼ í™œì„±í™”í•˜ëŠ” ì´‰ë°œ ìš”ì¸ì…ë‹ˆë‹¤.
- **ì‚¬ê±´ ë°œìƒ ê³µì‹**: P(Event) = f(ì›êµ­ ì ì¬ë ¥, ìš´ì˜ íŠ¸ë¦¬ê±°, ì‹œëŒ€ì  ë§¥ë½)
- ë¶„ì„ ì‹œ "ì›êµ­ì—ì„œ ì´ëŸ° ì ì¬ë ¥ì´ ìˆëŠ”ë°, ì˜¬í•´ ìš´ì—ì„œ ì´ ê¸°ìš´ì´ íŠ¸ë¦¬ê±°ë˜ì–´ ~í•œ ë³€í™”ê°€ ì˜ˆìƒë©ë‹ˆë‹¤"ë¼ëŠ” ë…¼ë¦¬ êµ¬ì¡°ë¥¼ ë”°ë¥´ì„¸ìš”.

## 2. ê³„ì ˆì„± ê¸°ë°˜ ì¡´ì¬ë¡  (Seasonal Ontology)
- **íƒœì–´ë‚œ ê³„ì ˆì´ ì¼ê°„ì˜ ì„±ì§ˆì„ ê²°ì •í•©ë‹ˆë‹¤.**
- ê³ ê°ì˜ íƒœì–´ë‚œ ê³„ì ˆ: **{birth_season}**
- ê°™ì€ {ilgan_oheng} ì¼ê°„ë„ ê³„ì ˆì— ë”°ë¼ ì „ëµì´ ë‹¬ë¼ì§‘ë‹ˆë‹¤:
  - ê²¨ìš¸ íƒœìƒ: ë¿Œë¦¬ ë‚´ë¦¼, ë‚´ì‹¤ ë‹¤ì§€ê¸°, í•™ìŠµê³¼ ì¤€ë¹„ì— ìœ ë¦¬
  - ì—¬ë¦„ íƒœìƒ: í™•ì¥, ì‹¤í–‰, ê²°ê³¼ ë„ì¶œì— ìœ ë¦¬
  - ë´„/ê°€ì„ íƒœìƒ: ê· í˜• ì¡íŒ ì„±ì¥ê³¼ ìˆ˜í™•

## 3. ê²¨ìš¸ ê½ƒ ì² í•™ (Winter Flower Philosophy)
- **ê¸°ë‹¤ë¦¼ â‰  ì‹¤íŒ¨**: ì¼ì´ ë§‰íˆê±°ë‚˜ ì˜¤ë˜ê±¸ë¦¬ëŠ” ê²ƒì€ 'ê¹Šì–´ì§€ëŠ” ì‹œê°„'ì…ë‹ˆë‹¤.
- **ë©ˆì¶¤ = ì¬ì •ë¹„**: ì–µì§€ë¡œ ì¶”ì§„í•˜ê¸°ë³´ë‹¤ ë¦¬ë“¬ì— ë§ì¶° ë£¨í‹´ì„ ì ê²€í•˜ëŠ” ê²ƒì´ í˜„ëª…í•©ë‹ˆë‹¤.
- **í•µì‹¬ ë©”ì‹œì§€**: "ê²¨ìš¸ì— íƒœì–´ë‚œ ê½ƒì€ ë´„ì— í”¼ëŠ” ê½ƒë³´ë‹¤ ëŠ¦ê²Œ í”¼ì§€ë§Œ, ê·¸ ë¿Œë¦¬ëŠ” ë” ê¹Šê³  í–¥ê¸°ëŠ” ë” ì˜¤ë˜ê°„ë‹¤."

## 4. ë¹„ê²°ì •ë¡ ì  ì–¸ì–´ (Non-Deterministic Language)
- **ì ˆëŒ€ ê¸ˆì§€**: "ì´í˜¼í•œë‹¤", "ì‚¬ì—… ë§í•œë‹¤", "ë°˜ë“œì‹œ ~í•´ì•¼ í•œë‹¤" ë“± ë‹¨ì •ì  ì˜ˆì–¸
- **ê¶Œì¥ í‘œí˜„**: "ê°ˆë“± ì—ë„ˆì§€ê°€ ê°ì§€ë©ë‹ˆë‹¤", "ë³€ë™ì„±ì´ ìˆìœ¼ë‹ˆ ë¶„ì‚° ì „ëµì„ ê¶Œí•©ë‹ˆë‹¤", "~í•˜ë©´ ë„ì›€ì´ ë  ìˆ˜ ìˆìŠµë‹ˆë‹¤"

---

# ì…ë ¥ ë°ì´í„°:

[ëª…ì‹ ì›êµ­ (Static Saju - ì ì¬ ì—ë„ˆì§€)]
- ì‚¬ì£¼ 4ì£¼: {saju_data['ë…„ì£¼']} {saju_data['ì›”ì£¼']} {saju_data['ì¼ì£¼']} {saju_data['ì‹œì£¼']}
- ì¼ê°„: {ilgan} ({ilgan_oheng})
- ì›”ì§€: {wolji} ({birth_season} íƒœìƒ)
- ì‹­ì„± ë°°ì—´: {saju_data['ì‹­ì„±_ê²°ê³¼_ë°°ì—´']}

[ìš´ì˜ íë¦„ (Dynamic Trigger)]
- ëŒ€ìš´ ì •ë³´: {daewoon_info['ëŒ€ìš´ìˆ˜']}ì„¸ ì‹œì‘, {daewoon_info['ìˆœí–‰_ì—­í–‰']}
- ëŒ€ìš´ ê°„ì§€ ë°°ì—´: {daewoon_info['ëŒ€ìš´_ê°„ì§€_ë°°ì—´'][:4]}...
- 2026ë…„ ì„¸ìš´: {sewoon_info[0]['year']}ë…„ {sewoon_info[0]['ganji']}

[ê³ ê° í˜ë¥´ì†Œë‚˜ (AI ë¬¸ì²´ ê°€ì´ë“œ)]
- ì¼ê°„ Style: {persona['style']} 
- ì–´ì¡° Instruction: {persona['instruction']}

[ê³ ê° í”„ë¡œí•„ ì •ë³´]
- ì§ì—… ìƒíƒœ: {profile_data.get('job', 'ì •ë³´ ì—†ìŒ') if profile_data else 'ì •ë³´ ì—†ìŒ'}
- ê²°í˜¼ ìƒíƒœ: {profile_data.get('marital', 'ì •ë³´ ì—†ìŒ') if profile_data else 'ì •ë³´ ì—†ìŒ'}
- ìë…€ ìœ ë¬´: {'ìˆìŒ' if profile_data and profile_data.get('children') else 'ì—†ìŒ'}

âš ï¸ **ì¤‘ìš”: ìœ„ ê³ ê° í”„ë¡œí•„ì— ë”°ë¼ ë¶„ì„ ë‚´ìš©ì„ ë§ì¶¤í™”í•˜ì„¸ìš”.**
- í•™ìƒ/ë¯¸ì„±ë…„ì: í•™ì—…ìš´, ì‹œí—˜ìš´, ì§„ë¡œ ìƒë‹´ì— ì§‘ì¤‘. ì—°ì• ìš´/ê²°í˜¼ìš´ ëŒ€ì‹  'ì¸ê°„ê´€ê³„'ë¡œ í‘œí˜„.
- ë¯¸í˜¼/ì‹±ê¸€: ì—°ì• ìš´, ì¸ì—° ì‹œê¸°, ìê¸° ì„±ì¥ì— ì§‘ì¤‘.
- ê¸°í˜¼/ìë…€ ìˆìŒ: ê°€ì • í™”ëª©, ë¶€ë¶€ ì†Œí†µ, ìë…€ êµìœ¡ì— ì§‘ì¤‘.
- ì§ì¥ì¸: ìŠ¹ì§„, ì´ì§, ì§ì¥ ë‚´ ì¸ê°„ê´€ê³„ì— ì§‘ì¤‘.
- ì‚¬ì—…ê°€/í”„ë¦¬ëœì„œ: ìˆ˜ìµí™”, íŒŒíŠ¸ë„ˆì‹­, í™•ì¥ ì‹œê¸°ì— ì§‘ì¤‘.

[ê³ ê° ì§ˆë¬¸]
{q}

[ê³ ê° ì¸ìƒ ì´ë ¥/ì„ìƒ ì‚¬ê±´]
{events if events else 'ì œê³µëœ ì´ë ¥ ì—†ìŒ'}

[ë°œë™ëœ íŠ¹ìˆ˜ íŒ¨í„´ ë¶„ì„ (ìí˜•/ì¶©/í˜•/ì‹ ì‚´)]
{pattern_analysis_str if pattern_analysis_str else '[ë°œë™ëœ íŠ¹ìˆ˜ íŒ¨í„´ ì—†ìŒ]'}

[ğŸ”´ ì¤‘ìš”: 2026ë…„ ì›”ë³„ ìš´ì„¸ ì ìˆ˜ (í…Œì´ë¸” ê¸°ë°˜ - ë°˜ë“œì‹œ ì°¸ì¡°)]
{_format_monthly_scores_for_prompt(monthly_scores)}

âš ï¸ **monthly_guide ì‘ì„± ì‹œ ë°˜ë“œì‹œ ìœ„ ì ìˆ˜ë¥¼ ì°¸ê³ í•˜ì„¸ìš”!**
- ì ìˆ˜ 70ì  ì´ìƒ: ê¸ì •ì  í…Œë§ˆ ("ê¸°íšŒì˜ ë‹¬", "ì„±ì·¨ì˜ ë‹¬", "ë„ì•½ì˜ ë‹¬" ë“±)
- ì ìˆ˜ 50~69ì : ì¤‘ë¦½ì  í…Œë§ˆ ("ì¤€ë¹„ì˜ ë‹¬", "ì ê²€ì˜ ë‹¬", "ì•ˆì •ì˜ ë‹¬" ë“±)  
- ì ìˆ˜ 50ì  ë¯¸ë§Œ: ì£¼ì˜ í…Œë§ˆ ("ì‹ ì¤‘ì˜ ë‹¬", "ì¶©ì „ì˜ ë‹¬", "ì ˆì œì˜ ë‹¬" ë“±)
- ê·¸ë˜í”„ ì ìˆ˜ì™€ í…ìŠ¤íŠ¸ ì„¤ëª…ì´ **ë°˜ë“œì‹œ ì¼ì¹˜**í•´ì•¼ í•©ë‹ˆë‹¤!

[AI ì°¸ê³ ìš© ì„ìƒ í†µê³„ ìë£Œ - ì ˆëŒ€ ì¶œë ¥ ê¸ˆì§€, ë‚´ë¶€ ì°¸ì¡°ìš©]
---START OF REFERENCE DATA---
{clinical_data_str[:10000]}  # ê¸¸ì´ ì œí•œ
---END OF REFERENCE DATA---

---

# ë¶„ì„ ìš”êµ¬ì‚¬í•­:

1. **[Emotional Opening]**: ì²« ë¬¸ë‹¨ì€ ì¼ê°„ Styleì„ í™œìš©í•˜ì—¬ ê³ ê°ì˜ ë³¸ì§ˆì„ ì¹­ì°¬í•˜ê³  ë”°ëœ»í•˜ê²Œ ì‹œì‘í•  ê²ƒ. ê³„ì ˆì„± ì¡´ì¬ë¡ ì„ ë°˜ì˜í•˜ì—¬ "{birth_season}ì— íƒœì–´ë‚œ {ilgan_oheng}ìœ¼ë¡œì„œì˜ ê°•ì "ì„ ì–¸ê¸‰í•  ê²ƒ.

2. **[Core Diagnosis]**: ë™ì  ìƒí˜¸ì‘ìš© ëª¨ë¸ì— ë”°ë¼ ë¶„ì„í•  ê²ƒ.
   - "ì›êµ­ì—ì„œ ~í•œ ì ì¬ë ¥ì´ ìˆëŠ”ë°"
   - "2026ë…„ ì„¸ìš´ì—ì„œ ~í•œ íŠ¸ë¦¬ê±°ê°€ ë“¤ì–´ì™€"
   - "~í•œ ë³€í™”/ê¸°íšŒ/ì£¼ì˜ì‚¬í•­ì´ ì˜ˆìƒë©ë‹ˆë‹¤"

3. **[Practical Strategy]**: ê³ ê°ì¸µ(3050 ì—¬ì„±, Nì¡/ìœ¡ì•„/ì°½ì—…)ì˜ í˜„ì‹¤ì  ë¬¸ì œ(ìˆ˜ìµí™”, ë£¨í‹´, ì§€ì†ë ¥)ì— ì´ˆì ì„ ë§ì¶° êµ¬ì²´ì ì¸ í•´ê²°ì±…ì„ ì œì‹œí•  ê²ƒ.

4. **[Key Actions]**: '30ì¼ ì´ë‚´ ì‹œì‘í•  ì‹¤ì „ í–‰ë™ 3ê°€ì§€'ë¥¼ ëª…í™•í•˜ê²Œ ë„ì¶œí•  ê²ƒ.

5. **[í”„ë¦¬ë¯¸ì—„ ë¶„ì„]**: wealth_timing, weakness_missions, psychological_relief, relationship_strategy, rest_calendar, digital_amulet ì„¹ì…˜ì„ ëª¨ë‘ ì±„ìš¸ ê²ƒ.

6. **[ë¹„ê²°ì •ë¡ ì  ì–¸ì–´]**: ëª¨ë“  ì˜ˆì¸¡ì—ì„œ ë‹¨ì •ì  í‘œí˜„ì„ í”¼í•˜ê³ , í™•ë¥ ì ì´ê³  ê±´ì„¤ì ì¸ ì–¸ì–´ë¥¼ ì‚¬ìš©í•  ê²ƒ.
"""
    return prompt


def analyze_ai_report(manse_info: Dict, daewoon_info: Dict, full_q: str, profile_data: Dict, events: str, engine_instance, api_key: str) -> Dict:
    """
    Gemini APIë¥¼ í˜¸ì¶œí•˜ì—¬ ìµœì¢… ì‚¬ì£¼ ë¶„ì„ JSON ë¦¬í¬íŠ¸ë¥¼ ìƒì„±í•©ë‹ˆë‹¤.
    
    [ë™ì  ìƒí˜¸ì‘ìš© ëª¨ë¸ ì ìš©]:
    - ì›êµ­(manse_info) = ì ì¬ ì—ë„ˆì§€
    - ìš´(daewoon_info + sewoon) = íŠ¸ë¦¬ê±°
    - AIê°€ ë‘˜ì˜ ìƒí˜¸ì‘ìš©ì„ ë¶„ì„í•˜ì—¬ ì‚¬ê±´/ì¡°ì–¸ì„ ìƒì„±
    
    [NEW: ëª…ë¦¬í•™ íŒ¨í„´ ë¶„ì„ í†µí•©]:
    - ìí˜•, ì¶©, í˜•, íŠ¹ìˆ˜ ì‹ ì‚´ íŒ¨í„´ ìë™ ê²€ì¶œ
    - ê²€ì¶œëœ íŒ¨í„´ì„ AI í”„ë¡¬í”„íŠ¸ì— ë°˜ì˜
    """
    
    # 1. AI í”„ë¡¬í”„íŠ¸ ìƒì„±ì— í•„ìš”í•œ ë°ì´í„° ì¤€ë¹„
    ilgan = manse_info['ì¼ì£¼'][0]
    clinical_data_str = load_clinical_data()
    sewoon_info = engine_instance.get_sewoon(datetime.datetime.now().year, 1) # í˜„ì¬ ì—°ë„ ì„¸ìš´ 1ë…„ì¹˜
    
    # 2. [NEW] ëª…ë¦¬í•™ íŠ¹ìˆ˜ íŒ¨í„´ ë¶„ì„
    matched_patterns = find_patterns_in_chart(manse_info)
    pattern_analysis_str = format_patterns_for_prompt(matched_patterns)
    
    # 3. [NEW] í…Œì´ë¸” ê¸°ë°˜ ì›”ë³„ ì ìˆ˜ ê³„ì‚° (AIì—ê²Œ ì „ë‹¬í•˜ì—¬ ì¼ê´€ëœ ê°€ì´ë“œ ì‘ì„± ìœ ë„)
    monthly_scores = calculate_monthly_flow_scores(manse_info)

    # 4. ìµœì¢… í”„ë¡¬í”„íŠ¸ ìƒì„± (get_final_ai_promptëŠ” ì´ë¯¸ ì •ì˜ë˜ì–´ ìˆìŒ)
    prompt = get_final_ai_prompt(
        ilgan=ilgan, 
        saju_data=manse_info, 
        daewoon_info=daewoon_info, 
        sewoon_info=sewoon_info, 
        q=full_q, 
        events=events, 
        clinical_data_str=clinical_data_str,
        pattern_analysis_str=pattern_analysis_str,  # NEW: íŒ¨í„´ ë¶„ì„ ê²°ê³¼ ì¶”ê°€
        profile_data=profile_data,  # NEW: ê³ ê° í”„ë¡œí•„ ë°ì´í„° ì¶”ê°€
        monthly_scores=monthly_scores  # NEW: í…Œì´ë¸” ê¸°ë°˜ ì›”ë³„ ì ìˆ˜ ì „ë‹¬
    )
    
    # 4. AI API í˜¸ì¶œ ë° ì‘ë‹µ ì²˜ë¦¬
    try:
        genai.configure(api_key=api_key)
        
        response = genai.GenerativeModel(
            'gemini-2.5-flash',
            system_instruction=get_system_instruction()
        ).generate_content(
            contents=[prompt],
            # ìˆ˜ì • ì™„ë£Œ: 'config'ë¥¼ 'generation_config'ë¡œ ë³€ê²½
            generation_config={
                "temperature": 0.5,
                "response_mime_type": "application/json",
            }
        )
        
        response_text = response.text.strip()
        
        # JSON íŒŒì‹± ì‹œ ì˜¤ë¥˜ ë°©ì§€
        clean_json_str = re.sub(r'```json|```', '', response_text, flags=re.IGNORECASE).strip()
        
        try:
            result_json = json.loads(clean_json_str)
            
            # ğŸ”§ ì›”ë³„ ì ìˆ˜ë¥¼ í…Œì´ë¸” ê¸°ë°˜ìœ¼ë¡œ ë®ì–´ì“°ê¸° (AI ìƒì„± ì ìˆ˜ ëŒ€ì²´)
            # ì´ë¡œì¨ ë™ì¼í•œ ì‚¬ì£¼ì— ëŒ€í•´ í•­ìƒ ë™ì¼í•œ ì›”ë³„ ì ìˆ˜ê°€ ë°˜í™˜ë¨
            result_json['monthly_flow'] = calculate_monthly_flow_scores(manse_info)
            
            # í”„ë¦¬ë¯¸ì—„ ì„¹ì…˜ ê¸°ë³¸ê°’ ë³´ì¥
            result_json = ensure_premium_sections(result_json, ilgan, manse_info)
            
        except json.JSONDecodeError as e:
             return {
                 "summary_card": {"keyword": f"âŒ AI ì‘ë‹µ íŒŒì‹± ì‹¤íŒ¨ (JSON ì˜¤ë¥˜)", "best_month": "N/A", "risk": "N/A", "action_item": "N/A"},
                 "raw_response": clean_json_str
             }
        
        return result_json

    except Exception as e:
        return {
            "summary_card": {"keyword": f"âŒ API í˜¸ì¶œ ì‹¤íŒ¨ - {type(e).__name__}", "best_month": "N/A", "risk": "N/A", "action_item": "N/A"},
            "raw_response": f"API í˜¸ì¶œ ë˜ëŠ” ì‘ë‹µ ìƒì„± ì¤‘ ì˜ˆìƒì¹˜ ëª»í•œ ì˜¤ë¥˜ ë°œìƒ: {str(e)}"
        }


def ensure_premium_sections(result_json: Dict, ilgan: str, manse_info: Dict) -> Dict:
    """
    í”„ë¦¬ë¯¸ì—„ ì„¹ì…˜ì´ ëˆ„ë½ëœ ê²½ìš° ê¸°ë³¸ê°’ì„ ì±„ì›Œë„£ìŠµë‹ˆë‹¤.
    """
    
    # ì¼ê°„ë³„ ìš©ì‹  ì˜¤í–‰ ë§¤í•‘ (ê°„ë‹¨ ë²„ì „)
    ilgan_yongsin_map = {
        'ç”²': 'í™”', 'ä¹™': 'í™”', 'ä¸™': 'í† ', 'ä¸': 'í† ',
        'æˆŠ': 'ê¸ˆ', 'å·±': 'ê¸ˆ', 'åºš': 'ìˆ˜', 'è¾›': 'ìˆ˜',
        'å£¬': 'ëª©', 'ç™¸': 'ëª©'
    }
    
    # ì¼ê°„ë³„ ìƒ‰ìƒ ë§¤í•‘
    yongsin_color_map = {
        'ëª©': '#A8D5BA',  # ì—°í•œ ë…¹ìƒ‰
        'í™”': '#FFB7B2',  # ì—°í•œ ë¹¨ê°•
        'í† ': '#E6CEAC',  # ì—°í•œ í™©í† ìƒ‰
        'ê¸ˆ': '#D3D3D3',  # ì—°í•œ íšŒìƒ‰
        'ìˆ˜': '#A2C2E0'   # ì—°í•œ íŒŒë‘
    }
    
    yongsin = ilgan_yongsin_map.get(ilgan, 'ìˆ˜')
    yongsin_color = yongsin_color_map.get(yongsin, '#A2C2E0')
    
    # wealth_timing ê¸°ë³¸ê°’
    if 'wealth_timing' not in result_json or not result_json['wealth_timing']:
        result_json['wealth_timing'] = {
            "risk_months": [3, 6, 9],
            "opportunity_months": [5, 10, 11],
            "strategy": f"{ilgan} ì¼ê°„ì—ê²Œ ì˜¬í•´ëŠ” ìƒë°˜ê¸° ì§€ì¶œ ê´€ë¦¬ì— ì§‘ì¤‘í•˜ê³ , í•˜ë°˜ê¸°ì— ìˆ˜ìµí™” ê¸°íšŒë¥¼ ë…¸ë¦¬ëŠ” ì „ëµì´ ìœ íš¨í•©ë‹ˆë‹¤."
        }
    
    # weakness_missions ê¸°ë³¸ê°’
    if 'weakness_missions' not in result_json or not result_json['weakness_missions']:
        result_json['weakness_missions'] = {
            "missing_element": "ë¹„ê²",
            "monthly_missions": {
                "1": "ë„¤íŠ¸ì›Œí¬ ê°•í™” í™œë™ ì‹œì‘",
                "2": "í˜‘ì—… íŒŒíŠ¸ë„ˆ ë¬¼ìƒ‰",
                "3": "ì†Œê·œëª¨ ëª¨ì„ ì£¼ìµœ",
                "4": "ë©˜í† ë§ ê´€ê³„ í˜•ì„±",
                "5": "íŒ€ í”„ë¡œì íŠ¸ ì°¸ì—¬",
                "6": "ê°€ì¡±/ì¹œêµ¬ì™€ ì •ê¸° ëª¨ì„",
                "7": "ê³µë™ ì°½ì‘ í™œë™",
                "8": "ì»¤ë®¤ë‹ˆí‹° í™œë™ ì°¸ì—¬",
                "9": "íŒŒíŠ¸ë„ˆì‹­ ê²€í† ",
                "10": "ì¡°ì–¸ì ê·¸ë£¹ êµ¬ì¶•",
                "11": "ë™ë°˜ì ê´€ê³„ ê°•í™”",
                "12": "ë‚´ë…„ ë„¤íŠ¸ì›Œí¬ ì „ëµ ìˆ˜ë¦½"
            }
        }
    
    # psychological_relief ê¸°ë³¸ê°’
    if 'psychological_relief' not in result_json or not result_json['psychological_relief']:
        result_json['psychological_relief'] = {
            "guilt_pattern": "ì„±ê³¼ì— ëŒ€í•œ ìê¸° ì••ë°•ê³¼ ì™„ë²½ì£¼ì˜",
            "reframing": "í˜„ì¬ì˜ ì •ì²´ëŠ” 'ì‹¤íŒ¨'ê°€ ì•„ë‹ˆë¼ 'ë¿Œë¦¬ë¥¼ ë‚´ë¦¬ëŠ” ì‹œê°„'ì…ë‹ˆë‹¤. ê²°ê³¼ë³´ë‹¤ ê³¼ì •ì— ì§‘ì¤‘í•˜ëŠ” 80% ì „ëµì„ ê¶Œì¥í•©ë‹ˆë‹¤.",
            "affirmation": "ë‚˜ëŠ” ì§€ê¸ˆ ì´ ìˆœê°„ì—ë„ ì¶©ë¶„íˆ ì„±ì¥í•˜ê³  ìˆë‹¤."
        }
    
    # relationship_strategy ê¸°ë³¸ê°’
    if 'relationship_strategy' not in result_json or not result_json['relationship_strategy']:
        result_json['relationship_strategy'] = {
            "pattern_name": "ë³´í˜¸í˜•",
            "boundary_guide": "1ë‹¨ê³„: ì¦‰ì‹œ ìˆ˜ë½ ëŒ€ì‹  'ìƒê°í•´ë³¼ê²Œ' ìŠµê´€í™”. 2ë‹¨ê³„: ë‚´ ì—ë„ˆì§€ ìƒíƒœ ì ê²€ í›„ ê²°ì •. 3ë‹¨ê³„: ê±°ì ˆí•´ë„ ê´€ê³„ê°€ ë¬´ë„ˆì§€ì§€ ì•ŠëŠ”ë‹¤ëŠ” ë¯¿ìŒ ê°–ê¸°.",
            "family_energy": "ê°€ì¡±ê³¼ì˜ ì†Œí†µì—ì„œ ì„œë¡œì˜ ë¦¬ë“¬ì„ ì¡´ì¤‘í•˜ê³ , ê°•ìš”ë³´ë‹¤ëŠ” ì œì•ˆì˜ í˜•íƒœë¡œ ëŒ€í™”í•˜ì„¸ìš”."
        }
    
    # rest_calendar ê¸°ë³¸ê°’
    if 'rest_calendar' not in result_json or not result_json['rest_calendar']:
        result_json['rest_calendar'] = {
            "burnout_months": [3, 6, 11],
            "rest_activities": f"{yongsin} ê¸°ìš´ì˜ íœ´ì‹ì´ í•„ìš”í•©ë‹ˆë‹¤. ë¬¼ê³¼ ê´€ë ¨ëœ í™œë™(ìˆ˜ì˜, ì˜¨ì²œ, ëª…ìƒ)ì´ë‚˜ ìì—° ì† ì‚°ì±…ì„ ê¶Œì¥í•©ë‹ˆë‹¤."
        }
    
    # digital_amulet ê¸°ë³¸ê°’
    if 'digital_amulet' not in result_json or not result_json['digital_amulet']:
        yongsin_quotes = {
            'ëª©': "ë‚˜ë¬´ëŠ” ë°”ëŒì— í”ë“¤ë ¤ë„ ë¿Œë¦¬ë¥¼ ë” ê¹Šì´ ë‚´ë¦½ë‹ˆë‹¤.",
            'í™”': "ë¹›ì€ ì–´ë‘  ì†ì—ì„œ ë”ìš± ë°ê²Œ ë¹›ë‚©ë‹ˆë‹¤.",
            'í† ': "ëŒ€ì§€ëŠ” ëª¨ë“  ê²ƒì„ í’ˆê³  í‚¤ì›Œëƒ…ë‹ˆë‹¤.",
            'ê¸ˆ': "ê¸ˆì€ ë‘ë“œë ¤ì§ˆìˆ˜ë¡ ë” ë‹¨ë‹¨í•´ì§‘ë‹ˆë‹¤.",
            'ìˆ˜': "ë¬¼ì€ ì¥ì• ë¬¼ì„ ë§Œë‚˜ë©´ ëŒì•„ íë¦…ë‹ˆë‹¤."
        }
        result_json['digital_amulet'] = {
            "yongsin_element": yongsin,
            "quote": yongsin_quotes.get(yongsin, "ë¬¼ì€ ì¥ì• ë¬¼ì„ ë§Œë‚˜ë©´ ëŒì•„ íë¦…ë‹ˆë‹¤."),
            "image_color": yongsin_color
        }
    
    return result_json


# --------------------------------------------------------------------------
# 5. í•µì‹¬ ì—”ì§„ í´ë˜ìŠ¤ (SajuEngine) - ì›êµ­, ëŒ€ìš´, ì„¸ìš´ ê³„ì‚° í†µí•©
# --------------------------------------------------------------------------

# astropy, numpy ë“± í•„ìš”í•œ ë¼ì´ë¸ŒëŸ¬ë¦¬ ì„í¬íŠ¸ëŠ” ì´ íŒŒì¼ ìƒë‹¨ì— ì´ë¯¸ ìˆìŠµë‹ˆë‹¤.
try:
    from astropy.time import Time
    from astropy.coordinates import solar_system_ephemeris, EarthLocation, get_sun, SkyCoord
    import astropy.units as u
    solar_system_ephemeris.set('de432s') 
except ImportError:
    # ì´ í™˜ê²½ì—ì„œ astropyê°€ ë¶ˆê°€ëŠ¥í•  ê²½ìš°, SajuEngineì€ ì‘ë™í•˜ì§€ ì•ŠìŠµë‹ˆë‹¤.
    pass


class SajuEngine:
    
    JEOLGI_DEGREES = {
        0: 'ç«‹æ˜¥', 30: 'é©šèŸ„', 60: 'æ·¸æ˜', 90: 'ç«‹å¤',
        120: 'èŠ’ç¨®', 150: 'å°æš‘', 180: 'ç«‹ç§‹', 210: 'ç™½éœ²',
        240: 'å¯’éœ²', 270: 'ç«‹å†¬', 300: 'å¤§é›ª', 330: 'å°å¯’'
    }

    def __init__(self):
        self.ganji_60 = GANJI_60
        self.cheongan = CHEONGAN
        self.jiji = JIJI

    def _find_jeolgi_time(self, target_degree: int, target_year: int) -> datetime.datetime:
        """astropyë¥¼ ì‚¬ìš©í•˜ì—¬ íŠ¹ì • í™©ê²½ ë„ë‹¬ ì‹œê° (KST)ì„ ê³„ì‚°í•©ë‹ˆë‹¤. (ê¸°ì¡´ ë¡œì§ ìœ ì§€)"""
        # ... (ë¡œì§ ìƒëµ)
        time_start = Time(f'{target_year}-01-01 00:00:00', format='iso', scale='utc')
        time_end = Time(f'{target_year+1}-03-01 00:00:00', format='iso', scale='utc')
        times = time_start + np.linspace(0, (time_end - time_start).to_value(u.day), 5000) * u.day
        sun_pos = get_sun(times)
        sun_ecliptic_lon = sun_pos.barycentrictrueecliptic.lon.to(u.deg).value
        target_lon = target_degree
        
        lon_diff = sun_ecliptic_lon - target_lon
        lon_diff[lon_diff > 180] -= 360
        lon_diff[lon_diff < -180] += 360
        
        crossing_index = np.where(np.diff(np.sign(lon_diff)))[0]
        
        if len(crossing_index) == 0:
             return self._find_jeolgi_time(target_degree, target_year + 1)

        idx = crossing_index[0]
        t1, t2 = times[idx], times[idx+1]
        l1, l2 = sun_ecliptic_lon[idx], sun_ecliptic_lon[idx+1]
        
        time_frac = (target_lon - l1) / (l2 - l1)
        time_jeolgi_utc = t1 + (t2 - t1) * time_frac
        
        return time_jeolgi_utc.to_datetime(timezone=TIME_ZONE)

    def _get_all_jeolgi_for_year(self, target_year: int) -> List[Dict]:
        """ì£¼ì–´ì§„ ì—°ë„ì— í•„ìš”í•œ ëª¨ë“  'ì ˆ(ç¯€)' ì‹œê°ì„ ê³„ì‚°í•©ë‹ˆë‹¤. (ê¸°ì¡´ ë¡œì§ ìœ ì§€)"""
        calculated_jeolgi = []
        for degree, name in self.JEOLGI_DEGREES.items():
            time_kst = self._find_jeolgi_time(degree, target_year)
            if time_kst and time_kst.year in [target_year, target_year + 1, target_year - 1]:
                 calculated_jeolgi.append({'datetime': time_kst, 'name': name, 'degree': degree})
        
        calculated_jeolgi.sort(key=lambda x: x['datetime'])
        return calculated_jeolgi

    def _get_day_ganji(self, dt: datetime.datetime) -> str:
        """ì¼ì£¼ (æ—¥æŸ±) ê³„ì‚° í•¨ìˆ˜ (ê¸°ì¤€ì¼ ç”²æˆŒæ—¥ë¡œ ìµœì¢… ë³€ê²½, ê¸°ì¡´ ë¡œì§ ìœ ì§€)"""
        REF_DATE = datetime.date(1900, 1, 1) 
        REF_DAY_GANJI_INDEX = 10 
        date_obj = dt.date()
        days_passed = (date_obj - REF_DATE).days
        day_ganji_index = (REF_DAY_GANJI_INDEX + days_passed) % 60
        return self.ganji_60[day_ganji_index]

    def _get_shi_ganji(self, day_gan: str, birth_hour: int) -> str:
        """ì‹œì£¼ (æ™‚æŸ±) ê³„ì‚° í•¨ìˆ˜ (ì‹œë‘ë²• ê¸°ë°˜, ê¸°ì¡´ ë¡œì§ ìœ ì§€)"""
        hour_index = (birth_hour + 1) % 24 // 2
        shi_zhi = self.jiji[hour_index % 12] 
        start_stem_index = DAY_STEM_TO_TIME_STEM_START_INDEX[day_gan]
        shi_gan_index = (start_stem_index + hour_index) % 10
        shi_gan = self.cheongan[shi_gan_index]
        return shi_gan + shi_zhi
        
    def generate_saju_palja(self, birth_dt: datetime.datetime, gender: str) -> Dict:
        """
        ìµœì¢… ì‚¬ì£¼íŒ”ì 8ê¸€ì ë° ëŒ€ìš´ ê³„ì‚°ì— í•„ìš”í•œ ì •ë³´ ë°˜í™˜
        ğŸš¨ ì‹­ì„± ê²°ê³¼ë¥¼ í¬í•¨í•˜ë„ë¡ ìµœì¢… ë°˜í™˜ êµ¬ì¡°ë¥¼ ìˆ˜ì •í–ˆìŠµë‹ˆë‹¤.
        """
        
        if birth_dt.tzinfo is None:
             birth_dt = birth_dt.replace(tzinfo=TIME_ZONE)
             
        day_ganji = self._get_day_ganji(birth_dt)
        day_gan = day_ganji[0]
        shi_ganji = self._get_shi_ganji(day_gan, birth_dt.hour)

        try:
            jeolgi_db_current = self._get_all_jeolgi_for_year(birth_dt.year)
            jeolgi_db_prev = self._get_all_jeolgi_for_year(birth_dt.year - 1)
            jeolgi_db_full = sorted(jeolgi_db_current + jeolgi_db_prev, key=lambda x: x['datetime'])
        except Exception as e:
            raise ValueError(f"ì ˆê¸° ê³„ì‚° ì¤‘ ì˜¤ë¥˜ ë°œìƒ: {e}")

        past_jeolgi = None
        future_jeolgi = None
        
        for dt_info in jeolgi_db_full:
            dt = dt_info['datetime']
            if dt <= birth_dt:
                past_jeolgi = dt_info
            elif dt > birth_dt:
                future_jeolgi = dt_info
                break

        if past_jeolgi is None:
             raise ValueError("ì ˆê¸° DBì— ì¶œìƒ ì‹œì ë³´ë‹¤ ì´ì „ ë°ì´í„°ê°€ ì—†ìŠµë‹ˆë‹¤.")

        # ë…„ì£¼ í™•ì • (ç«‹æ˜¥ ê¸°ì¤€)
        lipchun_dt = next((j['datetime'] for j in jeolgi_db_full if j['name'] == 'ç«‹æ˜¥' and j['datetime'].year == birth_dt.year), None)
        year_index_naive = (birth_dt.year - 1900 + 33) % 60
        
        if lipchun_dt and birth_dt < lipchun_dt:
            year_ganji_final = GANJI_60[(year_index_naive - 1 + 60) % 60]
        else:
            year_ganji_final = GANJI_60[year_index_naive]

        # ì›”ì£¼ í™•ì • (ì›”ê±´ë²•, ë…„ê°„ ê¸°ì¤€)
        month_zhi_index = (past_jeolgi['degree'] // 30) % 12
        month_zhi = JIJI[(month_zhi_index + 2) % 12]
        year_gan = year_ganji_final[0]
        month_stem_start_idx = YEAR_STEM_TO_MONTH_STEM_INDEX[year_gan]
        month_stem_idx = (month_stem_start_idx + month_zhi_index) % 10 
        month_gan = CHEONGAN[month_stem_idx]
        month_ganji = month_gan + month_zhi

        # ëŒ€ìš´ ì •ë³´ ê³„ì‚°
        daewoon_info = self._calculate_full_daewoon(year_ganji_final, month_ganji, birth_dt, gender, past_jeolgi['datetime'], future_jeolgi['datetime'])
        
        # ì‹­ì„± ê³„ì‚° (ì¶”ê°€ëœ ë¶€ë¶„)
        pillars_ganji = [year_ganji_final, month_ganji, day_ganji, shi_ganji]
        ten_gods_array = [calculate_pillar_sipsin(day_gan, g) for g in pillars_ganji]

        return {
            "ë…„ì£¼": year_ganji_final, "ì›”ì£¼": month_ganji, "ì¼ì£¼": day_ganji, "ì‹œì£¼": shi_ganji,
            "ëŒ€ìš´_ì •ë³´": daewoon_info,
            "ì¶œìƒì¼": birth_dt.strftime("%Y-%m-%d %H:%M:%S"),
            "ì¼ê°„": day_gan,
            "ì‹­ì„±_ê²°ê³¼_ë°°ì—´": ten_gods_array
        }

    def _calculate_full_daewoon(self, year_ganji: str, month_ganji: str, birth_dt: datetime.datetime, gender: str, past_jeolgi: datetime.datetime, future_jeolgi: datetime.datetime) -> Dict:
        """ëŒ€ìš´ìˆ˜, ìˆœ/ì—­í–‰, ëŒ€ìš´ ê°„ì§€ ë°°ì—´ì„ ê³„ì‚°"""
        year_gan = year_ganji[0]
        # ë…„ê°„ì˜ ìŒì–‘ íŒë‹¨: ç”²ä¸™æˆŠåºšå£¬(ì–‘), ä¹™ä¸å·±è¾›ç™¸(ìŒ)
        is_yang = year_gan in ['ç”²', 'ä¸™', 'æˆŠ', 'åºš', 'å£¬']
        
        # ìˆœí–‰/ì—­í–‰ ê²°ì •: ì–‘ë…„ìƒ ë‚¨/ìŒë…„ìƒ ì—¬ = ìˆœí–‰, ì–‘ë…„ìƒ ì—¬/ìŒë…„ìƒ ë‚¨ = ì—­í–‰
        is_forward = (is_yang and gender == 'M') or (not is_yang and gender == 'F')
        ê¸°ì¤€_ì ˆê¸° = future_jeolgi if is_forward else past_jeolgi
        
        if ê¸°ì¤€_ì ˆê¸° is None: return {"error": "ê¸°ì¤€ ì ˆê¸° ë°ì´í„° ë¶€ì¡±"}
        
        time_diff = abs(ê¸°ì¤€_ì ˆê¸° - birth_dt)
        days_diff = time_diff.total_seconds() / (24 * 3600)
        
        # ğŸš¨ [ìˆ˜ì • 1] ëŒ€ìš´ìˆ˜ ê³„ì‚° ì˜¤ë²„í”Œë¡œìš° ë°©ì§€ ë° ì˜¬ë¦¼ ì²˜ë¦¬
        days_per_age = days_diff / 3.0
        
        # math.ceil í•¨ìˆ˜ë¥¼ ì‚¬ìš©í•˜ì—¬ ë¬´ì¡°ê±´ ì˜¬ë¦¼ (ëŒ€ìš´ìˆ˜ ê³„ì‚° í‘œì¤€)
        # days_diffê°€ 0ë³´ë‹¤ í´ ê²½ìš°ì—ë§Œ ceil ì ìš©, days_diff=0ì¼ ê²½ìš° 1ë¡œ ì²˜ë¦¬
        if days_diff > 0:
            daewoon_su = int(ceil(days_per_age))
        else:
            daewoon_su = 1

        # ìµœì†Œ 1, ìµœëŒ€ 10ì„¸ ë²”ìœ„ë¡œ ê°•ì œ (100ì„¸ ì´ìƒ ì˜¤ë²„í”Œë¡œìš° ë°©ì§€)
        daewoon_su = max(1, min(10, daewoon_su)) 
            
        m_s_idx, m_b_idx = self.cheongan.index(month_ganji[0]), self.jiji.index(month_ganji[1])
        daewoon_list = []
        for i in range(1, 9): 
            # ğŸš¨ [ìˆ˜ì • 2] ëŒ€ìš´ ì‹œì‘ ë‚˜ì´ ê³„ì‚° ì‹œ ì˜¤ë²„í”Œë¡œìš° ë°©ì§€
            age_start = daewoon_su + (i - 1) * 10
            
            if is_forward:
                # ìˆœí–‰ (ì¸ë±ìŠ¤ ì¦ê°€)
                s_idx = (m_s_idx + i) % 10
                b_idx = (m_b_idx + i) % 12
            else:
                # ì—­í–‰ (ì¸ë±ìŠ¤ ê°ì†Œ)
                # ä¸™æˆŒ(2, 10)ì—ì„œ ì—­í–‰í•˜ë©´ i=1ì¼ ë•Œ ä¹™é…‰(1, 9)ê°€ ë©ë‹ˆë‹¤.
                s_idx = (m_s_idx - i + 10) % 10
                b_idx = (m_b_idx - i + 12) % 12

            daewoon_list.append({"age": age_start, "ganji": self.cheongan[s_idx] + self.jiji[b_idx]})
        
        return {
            "ëŒ€ìš´ìˆ˜": daewoon_su,
            "ìˆœí–‰_ì—­í–‰": "ìˆœí–‰" if is_forward else "ì—­í–‰",
            "ëŒ€ìš´_ê°„ì§€_ë°°ì—´": daewoon_list
        }
        
    def get_sewoon(self, current_year: int, count: int = 10) -> List[Dict]:
        """ì„¸ìš´ (æ­²é‹) ê³„ì‚° í•¨ìˆ˜ (ê¸°ì¡´ ë¡œì§ ìœ ì§€)"""
        sewoon_list = []
        start_index = (33 + (current_year - 1900)) % 60
        
        for i in range(count):
            year = current_year + i
            index = (start_index + i) % 60
            ganji = self.ganji_60[index]
            sewoon_list.append({"year": year, "ganji": ganji})
            
        return sewoon_list

# --------------------------------------------------------------------------
# ì´ ì•„ë˜ì— get_final_ai_prompt, analyze_ai_report í•¨ìˆ˜ ì •ì˜ê°€ ì´ì–´ì§‘ë‹ˆë‹¤.
# (ìœ„ìª½ 4. AI í”„ë¡¬í”„íŠ¸ ë° ë¶„ì„ í•¨ìˆ˜ ì¶”ê°€ ì„¹ì…˜ì— ì´ë¯¸ ì •ì˜ë˜ì–´ ìˆìŠµë‹ˆë‹¤.)
# --------------------------------------------------------------------------
